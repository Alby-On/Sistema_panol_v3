<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Login - Sistema Pañol</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">

            <div class="card shadow p-4">
                <h3 class="text-center">Iniciar Sesión</h3>

                <div id="msgLogin" class="text-center mb-2"></div>

                <input id="loginEmail" class="form-control mt-2" type="email" placeholder="Correo">
                <input id="loginPass" class="form-control mt-2" type="password" placeholder="Contraseña">

                <button class="btn btn-primary w-100 mt-3" onclick="login()">Ingresar</button>

                <hr>

                <h4 class="text-center">Crear Cuenta</h4>
                <div id="msgReg" class="text-center mb-2"></div>

                <input id="regNombre" class="form-control mt-2" placeholder="Nombre completo">
                <input id="regRut" class="form-control mt-2" placeholder="RUT (11.111.111-1)">
                <input id="regCarrera" class="form-control mt-2" placeholder="Carrera">
                <input id="regTelefono" class="form-control mt-2" placeholder="Teléfono +569...">
                <input id="regEmail" class="form-control mt-2" type="email" placeholder="Correo">
                <input id="regPass" class="form-control mt-2" type="password" placeholder="Contraseña">

                <button class="btn btn-success w-100 mt-3" onclick="registrar()">Crear Cuenta</button>
            </div>

        </div>
    </div>
</div>

<script>
// ------------------------------------
// INICIALIZAR SUPABASE
// ------------------------------------
const supabase = supabase.createClient(
    "TU_URL_SUPABASE",
    "TU_PUBLIC_ANON_KEY"
);

// ------------------------------------
// LOGIN
// ------------------------------------
async function login() {

    document.getElementById("msgLogin").textContent = "Verificando...";
    document.getElementById("msgLogin").style.color = "black";

    let email = loginEmail.value.trim();
    let pass = loginPass.value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password: pass
    });

    if (error) {
        document.getElementById("msgLogin").textContent = "❌ " + error.message;
        document.getElementById("msgLogin").style.color = "red";
        return;
    }

    // Obtener perfil desde tabla usuarios
    const { data: perfil, error: e2 } = await supabase
        .from("usuarios")
        .select("*")
        .eq("email", email)
        .single();

    if (e2) {
        document.getElementById("msgLogin").textContent =
            "❌ No se pudo obtener el perfil.";
        document.getElementById("msgLogin").style.color = "red";
        return;
    }

    // Guardar perfil en localStorage
    localStorage.setItem("userData", JSON.stringify(perfil));

    // Redirigir al menú
    window.location.href = "menu.html";
}

// ------------------------------------
// REGISTRO
// ------------------------------------
async function registrar() {

    let nombre = regNombre.value.trim();
    let rut = regRut.value.trim();
    let carrera = regCarrera.value.trim();
    let telefono = regTelefono.value.trim();
    let email = regEmail.value.trim();
    let pass = regPass.value.trim();

    document.getElementById("msgReg").textContent = "Procesando...";
    document.getElementById("msgReg").style.color = "black";

    // 1. Crear cuenta en Supabase Auth
    const { data: signupData, error: e1 } = await supabase.auth.signUp({
        email: email,
        password: pass
    });

    if (e1) {
        document.getElementById("msgReg").textContent = "❌ " + e1.message;
        document.getElementById("msgReg").style.color = "red";
        return;
    }

    // 2. Guardar perfil en tu tabla usuarios
    const { data: perfil, error: e2 } = await supabase
        .from("usuarios")
        .insert([{ nombre, rut, carrera, telefono, email }]);

    if (e2) {
        document.getElementById("msgReg").textContent =
            "❌ Error al crear perfil: " + e2.message;
        document.getElementById("msgReg").style.color = "red";
        return;
    }

    document.getElementById("msgReg").textContent =
        "✅ Cuenta creada. Revise su correo y confirme el registro.";
    document.getElementById("msgReg").style.color = "green";
}

</script>

</body>
</html>





