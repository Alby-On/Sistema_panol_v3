<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Revisi√≥n de Solicitudes</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Variables de Color (Consistencia Institucional) */
        :root {
            --color-primary: #004d99; /* Azul marino/institucional */
            --color-success: #28a745;
            --color-secondary: #6c757d;
            --color-background: #eef1f5; /* Fondo claro y suave */
            --color-card: #ffffff; /* Fondo de las tarjetas */
            --color-text: #333333;
            --color-border: #d0d5dd;
        }

        /* ---- ESTILO GENERAL ---- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            margin: 0;
            color: var(--color-text);
        }

        h1 {
            text-align: center;
            color: var(--color-primary);
            padding: 20px 0 10px;
            margin-bottom: 10px;
        }

        /* ---- CONTENEDOR PRINCIPAL (2 COLUMNAS) ---- */
        .panel-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1300px;
            margin: 0 auto;
        }

        /* ---- ESTILO DE COLUMNAS (PENDIENTES/ENTREGADAS) ---- */
        .panel-columna {
            flex: 1;
            background: var(--color-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-width: 300px; 
            border: 1px solid var(--color-border); /* Borde de la columna */
        }

        .panel-columna h2 {
            text-align: center;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.4em;
            color: var(--color-primary);
        }

        /* ---- ESTILO DE CADA TARJETA DE SOLICITUD ---- */
        .solicitud-card {
            border: 1px solid #e0e0e0;
            background: #fdfdfd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.95em;
        }

        .solicitud-card strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
            color: var(--color-primary);
        }
        
        .solicitud-card b {
            font-weight: 600;
        }

        /* Estilo para Materiales */
        .materiales-list {
            margin: 8px 0 0 15px;
            padding: 0;
            list-style-type: disc;
        }
        .materiales-list li {
            margin-bottom: 3px;
            color: var(--color-text);
        }

        /* Estilo para Textarea */
        .comentario-textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* Estilo para Botones de Acci√≥n */
        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-action {
            flex: 1;
            padding: 8px 10px; /* Reducido para encajar mejor */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: background-color 0.3s;
            color: white;
        }

        /* Bot√≥n Principal (Enviar comentario) */
        .btn-primary {
            background: var(--color-primary);
        }
        .btn-primary:hover {
            background: #003a73;
        }
        
        /* Bot√≥n Secundario (Sin comentarios) */
        .btn-secondary-action {
            background: var(--color-secondary); /* Gris institucional */
        }
        .btn-secondary-action:hover {
            background: #5a6268;
        }
        
        /* Estilo para mensajes de carga/vacio */
        .mensaje-estado {
            text-align: center;
            padding: 15px;
            background: #fff4e6;
            border: 1px solid #ffd7b3;
            color: #b95c00;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .mensaje-estado.success {
            background: #e6ffe6; 
            border-color: #b8ffb8; 
            color: var(--color-success);
        }

        /* ---- RESPONSIVE ---- */
        @media (max-width: 992px) {
            .panel-container {
                flex-direction: column; /* Apilar en pantallas m√°s peque√±as */
                padding: 10px;
            }
            .panel-columna {
                min-width: unset;
                margin-bottom: 15px;
            }
        }
    </style>
</head>

<body>
    <h1>üìã Panel de Gesti√≥n de Solicitudes</h1>

    <div class="panel-container">

        <div class="panel-columna">
            <h2>‚è≥ Solicitudes Pendientes</h2>
            <div id="colPendientes" class="mensaje-estado">Cargando...</div>
        </div>

        <div class="panel-columna">
            <h2>‚úÖ Solicitudes Entregadas</h2>
            <div id="colEntregadas" class="mensaje-estado">Cargando...</div>
        </div>

    </div>

<script>
    /* -------------------------
¬† ¬† ¬†CREAR CLIENTE SUPABASE (L√ìGICA INTACTA)
    ---------------------------- */
    const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<script>
/* -------------------------
¬† ¬†CARGAR SOLICITUDES PENDIENTES (L√ìGICA INTACTA)
---------------------------- */
async function getSolicitudesPendientes() {
    const { data, error } = await supabase
        .from("solicitudes")
        .select(`
            id,
            email,
            docente,
            asignatura,
            fecha_solicitud,
            estado,
            materiales_solicitados (
                material,
                cantidad
            )
        `)
        .eq("estado", "Pendiente")
        .order("fecha_solicitud", { ascending: true });

    if (error) {
        console.error("Error solicitudes pendientes:", error);
        return [];
    }
    return data;
}

/* -------------------------
¬† ¬†CARGAR SOLICITUDES ENTREGADAS (L√ìGICA INTACTA)
---------------------------- */
async function getSolicitudesEntregadas() {
    const { data, error } = await supabase
        .from("solicitudes")
        .select(`
            id,
            email,
            docente,
            asignatura,
            fecha_solicitud,
            fecha_entrega,
            estado,
            comentario_entrega
        `)
        .eq("estado", "Entregado")
        .or('comentario_entrega.is.null,comentario_entrega.eq.""')
        .order("fecha_entrega", { ascending: false });

    if (error) {
        console.error("Error solicitudes entregadas:", error);
        return [];
    }
    return data;
}

/* -------------------------
¬† ¬†ACTUALIZAR COMENTARIO EN BASE (L√ìGICA INTACTA)
---------------------------- */
async function actualizarComentario(id, comentario) {
    const { data, error } = await supabase
        .from("solicitudes")
        .update({ comentario_entrega: comentario })
        .eq("id", id);

    if (error) {
        console.error("Error actualizando comentario:", error);
        alert("Error al guardar comentario");
    } else {
        alert("Comentario guardado correctamente");
        cargarPanelSolicitudes(); // refresca la lista para ocultar la solicitud
    }
}

/* -------------------------
¬† ¬†RENDERIZAR COLUMNAS (L√ìGICA DE RENDERIZADO MODIFICADA S√ìLO PARA USAR CLASES)
---------------------------- */
async function cargarPanelSolicitudes() {
    const colPend = document.getElementById("colPendientes");
    const colEnt  = document.getElementById("colEntregadas");

    colPend.innerHTML = `<div class="mensaje-estado">Cargando...</div>`;
    colEnt.innerHTML = `<div class="mensaje-estado">Cargando...</div>`;

    const pendientes = await getSolicitudesPendientes();
    const entregadas = await getSolicitudesEntregadas();

    colPend.innerHTML = "";
    colEnt.innerHTML = "";

    /* ---- MOSTRAR PENDIENTES ---- */
    if (pendientes.length === 0) {
        colPend.innerHTML = `<div class="mensaje-estado success">‚úÖ No hay solicitudes pendientes.</div>`;
    } else {
        pendientes.forEach(s => {
            let matHTML = "";
            if (s.materiales_solicitados?.length > 0) {
                matHTML = s.materiales_solicitados
                    .map(m => `<li>${m.material} ‚Äî <strong>${m.cantidad}</strong></li>`)
                    .join("");
            }

            // USO DE CLASE .solicitud-card
            colPend.innerHTML += `
                <div class="solicitud-card">
                    <strong>Solicitud N¬∞ ${s.id}</strong><br>
                    <b>Docente:</b> ${s.docente}<br>
                    <b>Asignatura:</b> ${s.asignatura}<br>
                    <b>Fecha solicitud:</b> ${s.fecha_solicitud}<br><br>

                    <b>Materiales:</b>
                    <ul class="materiales-list">${matHTML}</ul>
                </div>
            `;
        });
    }

    /* ---- MOSTRAR ENTREGADAS CON TEXTAREA Y BOTONES ---- */
    if (entregadas.length === 0) {
        colEnt.innerHTML = `<div class="mensaje-estado success">üëç No hay entregas pendientes de comentario.</div>`;
    } else {
        entregadas.forEach(s => {
            // USO DE CLASES .solicitud-card, .comentario-textarea, .btn-group
            colEnt.innerHTML += `
                <div class="solicitud-card">
                    <strong>Solicitud N¬∞ ${s.id}</strong><br>
                    <b>Docente:</b> ${s.docente}<br>
                    <b>Asignatura:</b> ${s.asignatura}<br>
                    <b>Fecha solicitud:</b> ${s.fecha_solicitud}<br>
                    <b>Fecha entrega:</b> ${s.fecha_entrega}<br><br>

                    <textarea id="comentario-${s.id}" class="comentario-textarea" placeholder="Escribe un comentario..."></textarea>
                    
                    <div class="btn-group">
                        <button id="btnEnviarComentario-${s.id}" class="btn-action btn-primary">Enviar comentario</button>
                        <button id="btnSinComentario-${s.id}" class="btn-action btn-secondary-action">Sin comentarios</button>
                    </div>
                </div>
            `;

            // Listener para "Enviar comentario" (L√ìGICA INTACTA)
            document.getElementById(`btnEnviarComentario-${s.id}`).addEventListener("click", async () => {
                const texto = document.getElementById(`comentario-${s.id}`).value.trim();
                if (texto === "") {
                    alert("El comentario est√° vac√≠o");
                    return;
                }
                await actualizarComentario(s.id, texto);
            });

            // Listener para "Sin comentarios" (L√ìGICA INTACTA)
            document.getElementById(`btnSinComentario-${s.id}`).addEventListener("click", async () => {
                await actualizarComentario(s.id, "Sin comentario");
            });
        });
    }
}

/* -------------------------
¬† ¬†EJECUTAR AL CARGAR P√ÅGINA (L√ìGICA INTACTA)
---------------------------- */
document.addEventListener("DOMContentLoaded", cargarPanelSolicitudes);
</script>
</body>
</html>
