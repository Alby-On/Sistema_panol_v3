<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Solicitud de Materiales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    /* Variables de Color (Mismas que en las vistas anteriores) */
    :root {
        --color-primary: #004d99; /* Azul marino/institucional */
        --color-secondary: #28a745; /* Verde para enviar/√©xito */
        --color-info: #17a2b8; /* Turquesa para a√±adir */
        --color-danger: #dc3545; /* Rojo para eliminar */
        --color-muted: #6c757d; /* Gris para volver */
        --color-background: #eef1f5; /* Fondo claro y suave */
        --color-card: #ffffff; /* Fondo de las cajas */
        --color-text: #333333; /* Texto oscuro */
        --color-border: #cccccc;
    }

    /* Estilos Generales */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--color-background);
        margin: 0;
        padding: 0;
        color: var(--color-text);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
    }

    /* Caja Principal (Card) */
    .box {
        background: var(--color-card);
        padding: 25px;
        width: 100%;
        max-width: 780px; /* Ancho un poco mayor para la tabla */
        margin: 20px 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
    }

    /* Encabezados */
    h2 {
        text-align: center;
        margin-bottom: 25px;
        color: var(--color-primary);
        font-size: 1.8em;
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: 10px;
    }
    h3 { 
        text-align: center; 
        margin-top: 30px;
        margin-bottom: 15px;
        color: var(--color-primary);
        font-size: 1.3em;
    }

    /* Labels e Inputs de Formulario */
    label { 
        font-weight: 600; 
        display: block; 
        margin-top: 15px; 
        color: var(--color-text);
    }
    input, select {
        width: 100%;
        padding: 12px; /* Aumentado para mejor tacto en m√≥vil */
        font-size: 1em;
        margin-top: 8px;
        margin-bottom: 20px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        box-sizing: border-box;
        transition: border-color 0.3s;
    }
    input:focus, select:focus {
        border-color: var(--color-primary);
        outline: none;
        box-shadow: 0 0 5px rgba(0, 77, 153, 0.2);
    }

    /* Tabla de Materiales */
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Sombra sutil a la tabla */
    }
    th, td { 
        border: 1px solid #e0e0e0; /* Borde m√°s claro */
        padding: 12px; 
        text-align: left; /* Alineaci√≥n a la izquierda para el material */
    }
    th { 
        background: var(--color-primary); 
        color: var(--color-card); 
        text-align: center;
        text-transform: uppercase;
        font-size: 0.9em;
    }
    #tabla tbody tr:nth-child(even) {
        background-color: #f8f8f8; /* Cebra para mejor lectura */
    }
    td input { 
        padding: 8px; 
        font-size: 1em; 
        border: 1px solid #d0d0d0;
        margin: 0;
    }
    #tabla td:nth-child(2) { /* Columna de Cantidad */
        width: 25%;
        text-align: center;
    }

    /* Botones de Acci√≥n */
    .btnAdd, .btnRemove, .btnEnviar, .btnVolver {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 12px;
        transition: background-color 0.3s, opacity 0.3s;
    }

    .btnAdd { 
        background: var(--color-info); 
        color: white; 
    }
    .btnAdd:hover { background: #138496; }

    .btnRemove { 
        background: var(--color-danger); 
        color: white; 
    }
    .btnRemove:hover { background: #c82333; }

    .btnEnviar { 
        background: var(--color-secondary); 
        color: white; 
        margin-top: 25px; /* Separaci√≥n de los botones de la tabla */
    }
    .btnEnviar:hover { background: #1e7e34; }

    .btnVolver { 
        background: var(--color-muted); 
        color: white; 
    }
    .btnVolver:hover { background: #5a6268; }

    /* Estilos para M√≥viles */
    @media (max-width: 600px) {
        .box {
            margin: 10px;
            padding: 15px;
        }
        h2 {
            font-size: 1.6em;
        }
        th, td {
            padding: 8px;
            font-size: 0.9em;
        }
        td input {
            padding: 6px;
        }
        .btnAdd, .btnRemove, .btnEnviar, .btnVolver {
            font-size: 1em;
            padding: 12px;
        }
    }
</style>
</head>
<body>

<div class="box">
    <h2>Solicitud de Materiales üìã</h2>

    <label for="docente">üë®‚Äçüè´ Docente a cargo:</label>
    <select id="docente">
        <option value="">Seleccione un docente</option>
        <option>AAR√ìN EDUARDO SEP√öLVEDA MEDINA</option>
        <option>ALEJANDRO GABRIEL MOENA VALDERRAMA</option>
        <option>BRAYAN PATRICIO DEL VALLE AEDO</option>
        <option>DANIELA FERNANDA MART√çNEZ MART√çNEZ</option>
        <option>EDUARDO ARTURO BAST√çAS GARC√çA</option>
        <option>EL√çAS ANDR√âS POBLETE AVILA</option>
        <option>GERARDO NICOL√ÅS SEP√öLVEDA GUTI√âRREZ</option>
        <option>GIOVANNI ANDR√âS JARA TORRES</option>
        <option>JORGE ANDR√âS P√âREZ MILLAR</option>
        <option>JOSEFA CATALINA LISBOA RIVERA</option>
        <option>JULIO CESAR ALARCON MONTEROS</option>
        <option>MANUEL ALEJANDRO HENRIQUEZ OLIVA</option>
        <option>MARCO ANTONIO ARRIAGADA CASAS</option>
        <option>PEDRO PATRICIO PEDRERO P√âREZ</option>
        <option>RICHARD ANTONIO VALDERRAMA SAN MARTIN</option>
        <option>RICHARD NICOL√ÅS SANTOS MART√çNEZ</option>
        <option>ROBERTO SEBASTIAN CID LIZAMA</option>
        <option>RODRIGO ALEJANDRO CONTRERAS Z√ö√ëIGA</option>
        <option>RODRIGO ALEJANDRO GARRIDO GARRIDO</option>
        <option>ROLANDO EDUARDO ORTEGA FUENTES</option>
        <option>V√çCTOR EDUARDO ZAPATA MYRIK</option>
        <option>OTROS DOCENTES</option>
    </select>

    <label for="asignatura">üìö Asignatura:</label>
    <input type="text" id="asignatura" placeholder="Ej: Instalaciones El√©ctricas II">

    <h3>Materiales Solicitados</h3>

    <table id="tabla">
        <thead>
            <tr>
                <th>Material / Equipo</th>
                <th style="width: 25%;">Cantidad</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td><input type="text" placeholder="Ej: Mult√≠metro UT33C"></td>
                <td><input type="number" min="1" value="1"></td>
            </tr>
        </tbody>
    </table>

    <button class="btnAdd" onclick="addRow()">‚ûï Agregar Material</button>
    <button class="btnRemove" onclick="removeRow()">‚ûñ Eliminar √öltimo</button>
    
    <button class="btnEnviar" onclick="enviar()">üì§ Enviar Solicitud</button>
    <button class="btnVolver" onclick="location.href='menu.html'">‚Ü©Ô∏è Volver al Men√∫</button>
</div>

<script>
/* üîó Conexi√≥n a Supabase IGUAL que en index.html */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user) window.location.href = "index.html";

/* ‚ûï A√±adir fila (L√ìGICA INTACTA) */
function addRow() {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input type="text" placeholder="Ej: Cables de prueba"></td>
        <td><input type="number" min="1" value="1"></td>`;
    document.getElementById("tbody").appendChild(tr);
}

/* ‚ûñ Eliminar fila (L√ìGICA INTACTA) */
function removeRow() {
    const tbody = document.getElementById("tbody");
    if (tbody.rows.length > 1) tbody.deleteRow(tbody.rows.length - 1);
    else alert("Debe haber al menos un material.");
}

/* üì§ Enviar Solicitud (L√ìGICA INTACTA) */
async function enviar() {
    const btn = document.querySelector(".btnEnviar");
    btn.disabled = true;
    btn.innerText = "Enviando...";

    const docente = document.getElementById("docente").value;
    const asignatura = document.getElementById("asignatura").value.trim();
    const filas = document.querySelectorAll("#tbody tr");
    const materiales = [];

    if (!docente) return finishError("Seleccione un docente.");
    if (!asignatura) return finishError("Ingrese la asignatura.");

    filas.forEach(f => {
        const nombre = f.children[0].querySelector("input").value.trim();
        const cantidad = parseInt(f.children[1].querySelector("input").value.trim(), 10);
        if (nombre && cantidad) materiales.push({ material: nombre, cantidad });
    });

    if (materiales.length === 0) return finishError("Debe ingresar al menos un material.");

    try {
        /* 1Ô∏è‚É£ Insertar solicitud */
        const { data: solicitud, error } = await supabaseClient
            .from("solicitudes")
            .insert([{
                email: user.email,
                docente,
                asignatura,
                fecha_solicitud: new Date().toISOString(),
                estado: "Pendiente"
            }])
            .select()
            .single();

        if (error) throw error;

        /* 2Ô∏è‚É£ Insertar materiales */
        for (const m of materiales) {
            const { error } = await supabaseClient
                .from("materiales_solicitados")
                .insert([{ id_solicitud: solicitud.id, material: m.material, cantidad: m.cantidad }]);
            if (error) throw error;
        }

        alert("‚úÖ Solicitud enviada con √©xito.");
        window.location.href = "menu.html";

    } catch (err) {
        console.error(err);
        finishError("Error al enviar: " + err.message);
    }
}

function finishError(msg) {
    alert("‚ùå " + msg);
    const btn = document.querySelector(".btnEnviar");
    btn.disabled = false;
    btn.innerText = "Enviar Solicitud";
}

/* -------------------------------------------------------------------
   CARGAR DATOS CUANDO VIENE DESDE "REPETIR SOLICITUD"
------------------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {

    const params = new URLSearchParams(window.location.search);

    const docente = params.get("docente");
    const asignatura = params.get("asignatura");
    const materiales = JSON.parse(params.get("materiales") || "[]");
    const cantidades = JSON.parse(params.get("cantidades") || "[]");

    // 1Ô∏è‚É£ Rellenar docente autom√°ticamente
    if (docente) {
        const selectDocente = document.getElementById("docente");
        selectDocente.value = docente;
    }

    // 2Ô∏è‚É£ Rellenar asignatura autom√°ticamente
    if (asignatura) {
        document.getElementById("asignatura").value = asignatura;
    }

    // 3Ô∏è‚É£ Rellenar materiales
    if (materiales.length > 0) {

        // Limpia las filas actuales
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        // Crea filas seg√∫n los datos enviados
        for (let i = 0; i < materiales.length; i++) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" value="${materiales[i]}" /></td>
                <td><input type="number" min="1" value="${cantidades[i] || 1}" /></td>
            `;
            tbody.appendChild(tr);
        }
    }

});

</script>

</body>
</html>
