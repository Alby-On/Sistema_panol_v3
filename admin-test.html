<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes Pañol</title>

    <!-- ======================  
          ESTILOS  
    ====================== -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
        }

        .contenedor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .columna {
            background: white;
            padding: 20px;
            border-radius: 12px;
            height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 10px #00000020;
        }

        .titulo-col {
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .solicitud-card {
            background: #fafafa;
            border-left: 5px solid #007bff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 5px #00000015;
        }

        .solicitud-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #007bff;
        }

        .solicitud-card ul {
            padding-left: 18px;
        }

        .text-box {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: none;
            height: 70px;
        }

        .btn-box {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
        }

        .btn-enviar {
            background: #28a745;
            color: white;
        }

        .btn-sin {
            background: #6c757d;
            color: white;
        }
    </style>
</head>

<body>
    <h1>Gestión de Solicitudes — Pañol</h1>

    <div class="contenedor">
        <!-- ===================== COL 1 ===================== -->
        <div class="columna" id="colPendientes">
            <div class="titulo-col">Solicitudes Pendientes</div>
        </div>

        <!-- ===================== COL 2 ===================== -->
        <div class="columna" id="colEntregadas">
            <div class="titulo-col">Solicitudes Entregadas (sin comentario)</div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ============================
   CONFIGURACIÓN SUPABASE
============================= */
const SUPABASE_URL = "TU_URL";
const SUPABASE_ANON_KEY = "TU_API_KEY";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
   FUNCIÓN PRINCIPAL
============================= */
async function cargarSolicitudes() {
    const colPend = document.getElementById("colPendientes");
    const colEnt = document.getElementById("colEntregadas");

    colPend.innerHTML = '<div class="titulo-col">Solicitudes Pendientes</div>';
    colEnt.innerHTML = '<div class="titulo-col">Solicitudes Entregadas (sin comentario)</div>';

    /* ============================
       1. OBTENER SOLICITUDES
    ============================= */
    const { data: solicitudes, error: err1 } = await supabase
        .from("solicitudes")
        .select("*")
        .order("id", { ascending: false })
        .limit(40); // para evitar cargar miles

    if (err1) {
        console.error(err1);
        return;
    }

    /* ============================
       2. OBTENER MATERIALES
    ============================= */
    const { data: materiales, error: err2 } = await supabase
        .from("materiales_solicitados")
        .select("*");

    if (err2) {
        console.error(err2);
        return;
    }

    /* =====================================================
       3. UNIR SOLICITUDES + SUS MATERIALES ASOCIADOS
    ====================================================== */
    const solicitudesCompletas = solicitudes.map(s => {
        const mats = materiales.filter(m => m.id_solicitud === s.id);
        return { ...s, materiales: mats };
    });

    /* =====================================================
       4. DIVIDIR LISTAS
    ====================================================== */
    const pendientes = solicitudesCompletas.filter(s => s.estado === "Pendiente");

    const entregadasSinComentario = solicitudesCompletas.filter(
        s => s.estado === "Entregado" && (s.comentario_entrega === null || s.comentario_entrega === "")
    );

    /* =====================================================
       5. RENDER PENDIENTES
    ====================================================== */
    pendientes.forEach(s => {
        const card = document.createElement("div");
        card.className = "solicitud-card";

        card.innerHTML = `
            <h3>Solicitud #${s.id}</h3>
            <p><strong>Docente:</strong> ${s.docente}</p>
            <p><strong>Asignatura:</strong> ${s.asignatura}</p>
            <p><strong>Fecha solicitud:</strong> ${s.fecha_solicitud}</p>

            <h4>Materiales solicitados:</h4>
            <ul>
                ${s.materiales.map(m => `<li>${m.material} — ${m.cantidad} u.</li>`).join("")}
            </ul>
        `;

        colPend.appendChild(card);
    });

    /* =====================================================
       6. RENDER ENTREGADAS SIN COMENTARIO
    ====================================================== */
    entregadasSinComentario.forEach(s => {
        const card = document.createElement("div");
        card.className = "solicitud-card";

        card.innerHTML = `
            <h3>Solicitud #${s.id}</h3>
            <p><strong>Docente:</strong> ${s.docente}</p>
            <p><strong>Asignatura:</strong> ${s.asignatura}</p>
            <p><strong>Fecha entrega:</strong> ${s.fecha_entrega}</p>

            <h4>Materiales entregados:</h4>
            <ul>
                ${s.materiales.map(m => `<li>${m.material} — ${m.cantidad} u.</li>`).join("")}
            </ul>

            <textarea id="comentario_${s.id}" class="text-box" placeholder="Escribe un comentario..."></textarea>

            <div class="btn-box">
                <button class="btn btn-enviar" onclick="enviarComentario(${s.id})">Enviar comentario</button>
                <button class="btn btn-sin" onclick="enviarSinComentario(${s.id})">Sin comentario</button>
            </div>
        `;

        colEnt.appendChild(card);
    });
}

/* ============================
   GUARDAR COMENTARIO
============================= */
async function enviarComentario(id) {
    const txt = document.getElementById(`comentario_${id}`).value.trim();

    if (!txt) {
        alert("Escribe un comentario");
        return;
    }

    await supabase
        .from("solicitudes")
        .update({ comentario_entrega: txt })
        .eq("id", id);

    alert("Comentario guardado");
    cargarSolicitudes(); // refrescar lista
}

/* ============================
   GUARDAR SIN COMENTARIO
============================= */
async function enviarSinComentario(id) {
    await supabase
        .from("solicitudes")
        .update({ comentario_entrega: "Sin comentario" })
        .eq("id", id);

    alert("Guardado como 'Sin comentario'");
    cargarSolicitudes(); // refrescar lista
}

/* ============================
   INICIALIZAR
============================= */
cargarSolicitudes();
</script>

</body>
</html>

