<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Solicitudes</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold text-center mb-6">Panel de Solicitudes</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-7xl mx-auto">

        <div class="bg-white shadow-md rounded-xl p-4 border-t-4 border-yellow-500">
      <h2 class="text-2xl font-bold mb-4 text-yellow-600">Solicitudes Pendientes</h2>
      <div id="listaPendientes" class="space-y-4 max-h-[85vh] overflow-y-auto pr-2"></div>
    </div>

        <div class="bg-white shadow-md rounded-xl p-4 border-t-4 border-green-600">
      <h2 class="text-2xl font-bold mb-4 text-green-700">Solicitudes Entregadas (Sin Comentario)</h2>
      <div id="listaEntregadas" class="space-y-4 max-h-[85vh] overflow-y-auto pr-2"></div>
    </div>

  </div>

<script>
    // =============================
    //   CONFIGURAR SUPABASE
    // =============================
    const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =============================
    //   EJECUTAR CUANDO DOM ESTÉ LISTO
    // =============================
    document.addEventListener("DOMContentLoaded", () => {

        // =============================
        //   CREAR TARJETAS (Visualmente más prolijas)
        // =============================
        function crearCardPendiente(s, materiales) {
            // Añado una clase 'mb-1' y uso 'font-medium' para hacer los datos más compactos
            const materialesHTML = materiales.map(m => `<li class="text-gray-700">${m.material} — <span class="font-semibold">${m.cantidad} ud</span></li>`).join("");
            
            const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
            
            return `
              <div id="solicitud_${s.id}" class="p-4 bg-white border border-gray-200 rounded-lg shadow-md space-y-1">
                <p class="text-sm text-gray-500 mb-1"><strong class="text-gray-700">ID:</strong> ${s.id}</p>
                <p class="text-gray-800 font-medium"><strong>Solicitante:</strong> ${nombreSolicitante}</p>
                <p class="text-gray-800 font-medium"><strong>Docente:</strong> ${s.docente}</p>
                <p class="text-gray-800 font-medium"><strong>Asignatura:</strong> ${s.asignatura}</p>

                <p class="mt-2 pt-2 border-t font-semibold text-gray-700">Materiales:</p>
                <ul class="ml-4 list-disc text-sm space-y-0.5">${materialesHTML}</ul>
              </div>
            `;
        }

        function crearCardEntregada(s, materiales) {
            // Añado una clase 'mb-1' y uso 'font-medium' para hacer los datos más compactos
            const materialesHTML = materiales.map(m => `<li class="text-gray-700">${m.material} — <span class="font-semibold">${m.cantidad} ud</span></li>`).join("");
            
            const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
            
            return `
              <div id="solicitud_${s.id}" class="p-4 bg-white border border-gray-200 rounded-lg shadow-md space-y-1">
                <p class="text-sm text-gray-500 mb-1"><strong class="text-gray-700">ID:</strong> ${s.id}</p>
                <p class="text-gray-800 font-medium"><strong>Solicitante:</strong> ${nombreSolicitante}</p>
                <p class="text-gray-800 font-medium"><strong>Docente:</strong> ${s.docente}</p>
                <p class="text-gray-800 font-medium"><strong>Asignatura:</strong> ${s.asignatura}</p>

                <p class="mt-2 pt-2 border-t font-semibold text-gray-700">Materiales:</p>
                <ul class="ml-4 list-disc text-sm space-y-0.5">${materialesHTML}</ul>

                <div class="mt-3 pt-2 border-t">
                  <textarea id="coment_${s.id}" class="w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="Escribe un comentario..."></textarea>
                  <div class="flex gap-2 mt-2">
                    <button onclick="guardarComentario(${s.id})"
                      class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                      Enviar comentario
                    </button>
                    <button onclick="guardarSinComentario(${s.id})"
                      class="px-3 py-1 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600">
                      Sin comentario
                    </button>
                  </div>
                </div>
              </div>
            `;
        }

        // =============================
        //   CARGAR LISTAS (Lógica intacta)
        // =============================

        // --- Carga de Pendientes ---
        async function cargarPendientes() {
            const cont = document.getElementById("listaPendientes");
            
            const { data: solicitudes } = await supabase
                .from("solicitudes")
                .select("*, usuarios(nombre)") 
                .eq("estado", "Pendiente")
                .order("id", { ascending: false });

            let html = '';
            for (const s of solicitudes) {
                const { data: materiales } = await supabase
                    .from("materiales_solicitados")
                    .select("*")
                    .eq("id_solicitud", s.id);
                html += crearCardPendiente(s, materiales);
            }
            cont.innerHTML = html;
        }

        // --- Carga de Entregadas (Lógica intacta) ---
        async function cargarEntregadas() {
            const cont = document.getElementById("listaEntregadas");
            const comentariosGuardados = {};
            
            let focusedElementId = document.activeElement && document.activeElement.tagName === 'TEXTAREA' ? document.activeElement.id : null;

            document.querySelectorAll("#listaEntregadas textarea").forEach(textarea => {
                const id = textarea.id.replace("coment_", "");
                comentariosGuardados[id] = textarea.value;
            });

            const { data: solicitudes } = await supabase
                .from("solicitudes")
                .select("*, usuarios(nombre)") 
                .eq("estado", "Entregado")
                .is("comentario_entrega", null)
                .order("id", { ascending: false });

            let nuevoHtml = "";
            for (const s of solicitudes) {
                const { data: materiales } = await supabase
                    .from("materiales_solicitados")
                    .select("*")
                    .eq("id_solicitud", s.id);
                nuevoHtml += crearCardEntregada(s, materiales);
            }

            cont.innerHTML = nuevoHtml;

            solicitudes.forEach(s => {
                const id = s.id.toString();
                if (comentariosGuardados[id]) {
                    const textarea = document.getElementById(`coment_${id}`);
                    if (textarea) {
                        textarea.value = comentariosGuardados[id];
                    }
                }
            });

            if (focusedElementId) {
                const restoredFocusElement = document.getElementById(focusedElementId);
                if (restoredFocusElement) {
                    restoredFocusElement.focus();
                    const currentLength = restoredFocusElement.value.length;
                    restoredFocusElement.setSelectionRange(currentLength, currentLength);
                }
            }
        }

        async function cargarTodo() {
            await cargarPendientes();
            await cargarEntregadas();
        }

        // =============================
        //  FUNCIONES DE COMENTARIO (Lógica intacta)
        // =============================
        window.guardarComentario = async function(id) {
            const txt = document.getElementById(`coment_${id}`).value.trim();
            if (!txt) return alert("Escribe un comentario primero.");
            await supabase
                .from("solicitudes")
                .update({ comentario_entrega: txt })
                .eq("id", id);
            cargarTodo();
        }

        window.guardarSinComentario = async function(id) {
            await supabase
                .from("solicitudes")
                .update({ comentario_entrega: "Sin comentario" })
                .eq("id", id);
            cargarTodo();
        }

        // =============================
        //   AUTO-ACTUALIZACIÓN 5s (Lógica intacta)
        // =============================
        cargarTodo();
        setInterval(cargarTodo, 5000);

    }); // fin DOMContentLoaded
</script>
</body>
</html>
