<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes Pañol</title>

    <!-- ======================  
          ESTILOS  
    ====================== -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
        }

        .contenedor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .columna {
            background: white;
            padding: 20px;
            border-radius: 12px;
            height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 10px #00000020;
        }

        .titulo-col {
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .solicitud-card {
            background: #fafafa;
            border-left: 5px solid #007bff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 5px #00000015;
        }

        .solicitud-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #007bff;
        }

        .solicitud-card ul {
            padding-left: 18px;
        }

        .text-box {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: none;
            height: 70px;
        }

        .btn-box {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
        }

        .btn-enviar {
            background: #28a745;
            color: white;
        }

        .btn-sin {
            background: #6c757d;
            color: white;
        }
    </style>
</head>

<body>
    <h1>Gestión de Solicitudes — Pañol</h1>

    <div class="contenedor">
        <!-- ===================== COL 1 ===================== -->
        <div class="columna" id="colPendientes">
            <div class="titulo-col">Solicitudes Pendientes</div>
        </div>

        <!-- ===================== COL 2 ===================== -->
        <div class="columna" id="colEntregadas">
            <div class="titulo-col">Solicitudes Entregadas (sin comentario)</div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// =============================
//   ACTUALIZAR AUTOMÁTICO
// =============================

// Ejecutar al cargar la página
document.addEventListener("DOMContentLoaded", () => {
    cargarSolicitudesPendientes();
    cargarSolicitudesEntregadas();
});

// Refrescar SOLO las listas cada 4 segundos
setInterval(() => {
    cargarSolicitudesPendientes();
    cargarSolicitudesEntregadas();
}, 4000);

// =============================
//   SOLICITUDES PENDIENTES
// =============================

async function cargarSolicitudesPendientes() {
    const { data, error } = await supabase
        .from("solicitudes")
        .select(`
            id,
            email,
            docente,
            asignatura,
            fecha_solicitud,
            estado,
            materiales_solicitados ( material, cantidad )
        `)
        .eq("estado", "Pendiente")
        .order("fecha_solicitud", { ascending: false });

    if (error) {
        console.error("Error pendientes:", error);
        return;
    }

    const contenedor = document.getElementById("columnaPendientes");
    contenedor.innerHTML = "";

    data.forEach(s => {
        const div = document.createElement("div");
        div.classList.add("card-solicitud");

        div.innerHTML = `
            <h3>ID #${s.id}</h3>
            <p><strong>Docente:</strong> ${s.docente}</p>
            <p><strong>Asignatura:</strong> ${s.asignatura}</p>
            <p><strong>Email:</strong> ${s.email}</p>
            <p><strong>Fecha:</strong> ${s.fecha_solicitud}</p>

            <h4>Materiales:</h4>
            <ul>
                ${s.materiales_solicitados.map(m => `
                    <li>${m.material} — <strong>${m.cantidad}</strong></li>
                `).join("")}
            </ul>
        `;

        contenedor.appendChild(div);
    });
}

// =============================
//   SOLICITUDES ENTREGADAS (Sin comentario)
// =============================

async function cargarSolicitudesEntregadas() {
    const { data, error } = await supabase
        .from("solicitudes")
        .select(`
            id,
            email,
            docente,
            asignatura,
            fecha_entrega,
            estado,
            comentario_entrega,
            materiales_solicitados ( material, cantidad )
        `)
        .eq("estado", "Entregado")
        .is("comentario_entrega", null)
        .order("fecha_entrega", { ascending: false });

    if (error) {
        console.error("Error entregadas:", error);
        return;
    }

    const contenedor = document.getElementById("columnaEntregadas");
    contenedor.innerHTML = "";

    data.forEach(s => {
        const div = document.createElement("div");
        div.classList.add("card-solicitud");

        div.innerHTML = `
            <h3>ID #${s.id}</h3>
            <p><strong>Docente:</strong> ${s.docente}</p>
            <p><strong>Asignatura:</strong> ${s.asignatura}</p>
            <p><strong>Email:</strong> ${s.email}</p>
            <p><strong>Fecha entrega:</strong> ${s.fecha_entrega}</p>

            <h4>Materiales:</h4>
            <ul>
                ${s.materiales_solicitados.map(m => `
                    <li>${m.material} — <strong>${m.cantidad}</strong></li>
                `).join("")}
            </ul>

            <textarea id="comentario_${s.id}" placeholder="Comentario entrega"></textarea>
            <button onclick="guardarComentario(${s.id})">Guardar</button>
            <button onclick="guardarSinComentario(${s.id})">Sin comentario</button>
        `;

        contenedor.appendChild(div);
    });
}

// =============================
//   FUNCIONES DE BOTONES
// =============================

async function guardarComentario(id) {
    const comentario = document.getElementById(`comentario_${id}`).value;

    await supabase
        .from("solicitudes")
        .update({ comentario_entrega: comentario })
        .eq("id", id);

    cargarSolicitudesEntregadas();
}

async function guardarSinComentario(id) {
    await supabase
        .from("solicitudes")
        .update({ comentario_entrega: "Sin comentario" })
        .eq("id", id);

    cargarSolicitudesEntregadas();
}
</script>



</body>
</html>

