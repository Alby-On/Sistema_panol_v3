<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Entregar Materiales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .box { background:white; padding:20px; border-radius:10px; max-width:600px; margin:auto;
           box-shadow:0 0 10px rgba(0,0,0,0.15); }
    h2 { text-align:center; }
    .solicitud { padding:15px; margin-top:15px; border:1px solid #ccc; border-radius:10px; background:#fafafa; }
    .material { padding:8px; border-bottom:1px solid #ddd; }
    button { padding:10px; width:100%; border:none; border-radius:7px; background:#007bff; color:white; cursor:pointer; }
    button:hover { opacity:0.9; }
    .disabled { background:#999 !important; cursor:not-allowed; }
  </style>
</head>
<body>

<div class="box">
  <h2>Solicitudes Pendientes</h2>
  <div id="contenedor"></div>
</div>

<script>
/* üîó Conexi√≥n Supabase */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* üîê Verificar sesi√≥n */
async function verificarSesion() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
        alert("Debe iniciar sesi√≥n.");
        window.location.href = "index.html";
        return;
    }
    return session.user;
}

/* üì¶ Cargar solicitudes pendientes */
async function cargarSolicitudes() {

    const user = await verificarSesion();
    if (!user) return;

    const cont = document.getElementById("contenedor");
    cont.innerHTML = "<p>Cargando...</p>";

    const { data: solicitudes, error } = await supabaseClient
        .from("solicitudes")
        .select("id, docente, asignatura, fecha, estado")
        .eq("estado", "Pendiente")
        .eq("email", user.email);

    if (error) {
        cont.innerHTML = "<p>Error cargando solicitudes</p>";
        console.error(error);
        return;
    }

    if (solicitudes.length === 0) {
        cont.innerHTML = "<p>No tienes solicitudes pendientes.</p>";
        return;
    }

    cont.innerHTML = "";

    for (const sol of solicitudes) {

        // üßæ Obtener materiales de cada solicitud
        const { data: materiales } = await supabaseClient
            .from("materiales_solicitados")
            .select("id, material, cantidad")
            .eq("id_solicitud", sol.id);

        const div = document.createElement("div");
        div.className = "solicitud";

        div.innerHTML = `
          <h3>Solicitud #${sol.id}</h3>
          <p><b>Docente:</b> ${sol.docente}</p>
          <p><b>Asignatura:</b> ${sol.asignatura}</p>
          <p><b>Fecha:</b> ${sol.fecha}</p>
          <h4>Materiales solicitados:</h4>
        `;

        const listaDiv = document.createElement("div");
        listaDiv.id = "lista-" + sol.id;

        materiales.forEach(mat => {
            const row = document.createElement("div");
            row.className = "material";
            row.innerHTML = `
                <input type="checkbox" class="chk" data-id="${sol.id}">
                ${mat.material} ‚Äî <b>${mat.cantidad}</b>
            `;
            listaDiv.appendChild(row);
        });

        div.appendChild(listaDiv);

        const btn = document.createElement("button");
        btn.textContent = "Confirmar Entrega";
        btn.classList.add("disabled");
        btn.disabled = true;

        btn.onclick = () => {
            alert("Entrega lista para confirmar (no implementado a√∫n)");
        };

        // üü° Habilitar bot√≥n solo si todos los check est√°n marcados
        listaDiv.addEventListener("change", () => {
            const checks = listaDiv.querySelectorAll(".chk");
            const todosMarcados = [...checks].every(c => c.checked);

            if (todosMarcados) {
                btn.classList.remove("disabled");
                btn.disabled = false;
            } else {
                btn.classList.add("disabled");
                btn.disabled = true;
            }
        });

        div.appendChild(btn);
        cont.appendChild(div);
    }
}

cargarSolicitudes();
</script>

</body>
</html>

