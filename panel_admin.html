<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Solicitudes - Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

    <style>
        /* Definir paleta de colores personalizada */
        .color-primary { color: #004d99; }
        .bg-primary { background-color: #004d99; }
        .hover\:bg-primary-dark:hover { background-color: #003a73; }
        .border-primary { border-color: #004d99; }
        
        /* Ajuste de colores para Pendientes (Amarillo/Naranja) y Entregadas (Verde) */
        .border-t-pending { border-color: #ffc107; }
        .text-pending { color: #ff8c00; }
        .border-t-done { border-color: #28a745; }
        .text-done { color: #28a745; }

        /* Estilo General y Fuente */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Estilo de la barra de desplazamiento para los contenedores */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #edf2f7; }
        
        /* Ocultar el panel de solicitudes por defecto */
        #panelSolicitudes {
            display: none;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 p-6">
    <h1 class="text-4xl font-extrabold text-center mb-8 color-primary">
        Gesti√≥n de Solicitudes de Material
    </h1>
    
    <div id="accessStatus" class="max-w-7xl mx-auto mb-6">
        <div class="p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg text-center font-semibold">
            Verificando acceso de administrador...
        </div>
    </div>

    <div id="panelSolicitudes" class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-7xl mx-auto">

        <div class="bg-white shadow-xl rounded-xl p-6 border-t-8 border-t-pending">
            <h2 class="text-3xl font-bold mb-5 text-pending">
                <span class="mr-2">‚è≥</span> Solicitudes Pendientes
            </h2>
            <div id="listaPendientes" class="space-y-4 max-h-[75vh] overflow-y-auto custom-scrollbar pr-3">
                <div class="p-4 text-center text-gray-500">Cargando solicitudes...</div>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 border-t-8 border-t-done">
            <h2 class="text-3xl font-bold mb-5 text-done">
                <span class="mr-2">üìù</span> Entregadas (Pendiente Comentario)
            </h2>
            <div id="listaEntregadas" class="space-y-4 max-h-[75vh] overflow-y-auto custom-scrollbar pr-3">
                <div class="p-4 text-center text-gray-500">Cargando entregas...</div>
            </div>
        </div>

    </div>

<script>
    // =============================
    // ¬† CONFIGURAR SUPABASE
    // =============================
    const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
    // Nota: Usar la clave ANON KEY est√° bien si la RLS est√° correctamente configurada
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let isAdmin = false; // Variable global para el estado del rol
    let refreshInterval = null; // Variable para el intervalo de actualizaci√≥n

    // =============================
    // ¬† FUNCI√ìN DE VERIFICACI√ìN DE ACCESO
    // =============================
    async function checkAdminAccess() {
        const accessStatus = document.getElementById("accessStatus");
        const panel = document.getElementById("panelSolicitudes");
        
        // 1. Obtener la sesi√≥n del usuario
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error || !session) {
            accessStatus.innerHTML = `
                <div class="p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg text-center font-semibold">
                    Acceso denegado: Necesitas iniciar sesi√≥n para ver este panel.
                </div>
            `;
            isAdmin = false;
            return;
        }
        
        // 2. Leer el tipo_usuario de los metadatos
        // IMPORTANTE: Aseg√∫rate que 'tipo_usuario' es el campo correcto en user_metadata.
        const userRole = session.user.user_metadata.tipo_usuario;
        
        if (userRole === 'Admin') {
            isAdmin = true;
            accessStatus.innerHTML = `
                <div class="p-2 bg-green-100 border border-green-300 text-green-800 rounded-lg text-center font-semibold text-sm">
                    Acceso concedido. (Rol: Admin)
                </div>
            `;
            panel.style.display = 'grid'; // Mostrar panel
            cargarTodo();
            // Iniciar auto-actualizaci√≥n solo si es Admin
            if (!refreshInterval) {
                 refreshInterval = setInterval(cargarTodo, 5000);
            }
        } else {
            accessStatus.innerHTML = `
                <div class="p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg text-center font-semibold">
                    Acceso denegado: Tu rol (${userRole}) no tiene permisos para este panel.
                </div>
            `;
            isAdmin = false;
            panel.style.display = 'none'; // Ocultar panel
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    }


    // =============================
    // ¬† C√ìDIGO DE RENDERIZADO (Se mantiene igual)
    // =============================
    
    function displayEmptyMessage(container, isPending) {
        const color = isPending ? 'text-pending' : 'text-done';
        const icon = isPending ? 'üéâ' : 'üëç';
        const message = isPending ? 'No hay solicitudes pendientes actualmente.' : 'No hay entregas pendientes de comentario.';
        
        container.innerHTML = `
            <div class="p-6 text-center bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <p class="text-xl ${color} font-semibold mb-1">${icon}</p>
                <p class="text-gray-600">${message}</p>
            </div>
        `;
    }

    function crearCardPendiente(s, materiales) {
        const materialesHTML = materiales.map(m => `<li class="ml-4 list-disc"><span class="font-medium">${m.material}</span> ‚Äî <span class="text-gray-700">${m.cantidad} ud</span></li>`).join("");
        const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
        
        return `
            <div id="solicitud_${s.id}" class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition duration-200">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-600">ID: <span class="font-mono text-xs">${s.id}</span></p>
                    <span class="px-2 py-0.5 text-xs font-semibold bg-yellow-100 text-pending rounded-full">Pendiente</span>
                </div>
                
                <p class="text-base font-semibold color-primary">Solicitante: <span class="font-normal text-gray-800">${nombreSolicitante}</span></p>
                <p class="text-sm">Docente: <span class="font-medium text-gray-700">${s.docente}</span></p>
                <p class="text-sm mb-3">Asignatura: <span class="font-medium text-gray-700">${s.asignatura}</span></p>

                <p class="mt-2 font-bold text-gray-700">Materiales solicitados:</p>
                <ul class="text-sm list-none space-y-1">${materialesHTML}</ul>
            </div>
        `;
    }

    function crearCardEntregada(s, materiales) {
        const materialesHTML = materiales.map(m => `<li class="ml-4 list-disc"><span class="font-medium">${m.material}</span> ‚Äî <span class="text-gray-700">${m.cantidad} ud</span></li>`).join("");
        const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
        
        return `
            <div id="solicitud_${s.id}" class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition duration-200">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-600">ID: <span class="font-mono text-xs">${s.id}</span></p>
                    <span class="px-2 py-0.5 text-xs font-semibold bg-green-100 text-done rounded-full">Entregado</span>
                </div>

                <p class="text-base font-semibold color-primary">Solicitante: <span class="font-normal text-gray-800">${nombreSolicitante}</span></p>
                <p class="text-sm">Docente: <span class="font-medium text-gray-700">${s.docente}</span></p>
                <p class="text-sm mb-3">Asignatura: <span class="font-medium text-gray-700">${s.asignatura}</span></p>
                
                <p class="mt-2 font-bold text-gray-700">Materiales entregados:</p>
                <ul class="text-sm list-none space-y-1">${materialesHTML}</ul>

                <div class="mt-4 pt-3 border-t border-gray-200">
                    <textarea id="coment_${s.id}" class="w-full p-3 border border-gray-300 rounded-lg text-sm resize-y focus:ring-2 focus:ring-primary focus:border-primary" 
                            placeholder="Escribe un comentario sobre la devoluci√≥n/estado..."></textarea>
                    
                    <div class="flex gap-3 mt-3">
                        <button onclick="guardarComentario(${s.id})"
                            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg text-sm font-semibold hover:bg-primary-dark transition duration-150">
                            <span class="mr-1">üí¨</span> Enviar comentario
                        </button>
                        <button onclick="guardarSinComentario(${s.id})"
                            class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg text-sm font-semibold hover:bg-gray-600 transition duration-150">
                            <span class="mr-1">‚úî</span> Sin comentario
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // --- Carga de Pendientes ---
    async function cargarPendientes() {
        if (!isAdmin) return; // Solo cargar si es Admin
        const cont = document.getElementById("listaPendientes");
        
        // La RLS de Supabase ahora debe manejar el acceso a TODOS los datos
        const { data: solicitudes } = await supabase
            .from("solicitudes")
            .select("*, usuarios(nombre)")¬†
            .eq("estado", "Pendiente")
            .order("id", { ascending: false });
        
        if (!solicitudes || solicitudes.length === 0) {
            displayEmptyMessage(cont, true);
            return;
        }

        let html = '';
        for (const s of solicitudes) {
            const { data: materiales } = await supabase
                .from("materiales_solicitados")
                .select("*")
                .eq("id_solicitud", s.id);
            
            html += crearCardPendiente(s, materiales);
        }
        cont.innerHTML = html;
    }

    // --- Carga de Entregadas (con l√≥gica para preservar foco y comentarios) ---
    async function cargarEntregadas() {
        if (!isAdmin) return; // Solo cargar si es Admin
        const cont = document.getElementById("listaEntregadas");
        const comentariosGuardados = {};
        
        let focusedElementId = document.activeElement && document.activeElement.tagName === 'TEXTAREA' ? document.activeElement.id : null;

        document.querySelectorAll("#listaEntregadas textarea").forEach(textarea => {
            const id = textarea.id.replace("coment_", "");
            comentariosGuardados[id] = textarea.value;
        });

        // La RLS de Supabase ahora debe manejar el acceso a TODOS los datos
        const { data: solicitudes } = await supabase
            .from("solicitudes")
            .select("*, usuarios(nombre)")¬†
            .eq("estado", "Entregado")
            .is("comentario_entrega", null)
            .order("id", { ascending: false });

        if (!solicitudes || solicitudes.length === 0) {
            displayEmptyMessage(cont, false);
            return;
        }

        let nuevoHtml = "";
        for (const s of solicitudes) {
            const { data: materiales } = await supabase
                .from("materiales_solicitados")
                .select("*")
                .eq("id_solicitud", s.id);
            
            nuevoHtml += crearCardEntregada(s, materiales);
        }

        cont.innerHTML = nuevoHtml;

        solicitudes.forEach(s => {
            const id = s.id.toString();
            if (comentariosGuardados[id]) {
                const textarea = document.getElementById(`coment_${id}`);
                if (textarea) {
                    textarea.value = comentariosGuardados[id];
                }
            }
        });

        if (focusedElementId) {
            const restoredFocusElement = document.getElementById(focusedElementId);
            if (restoredFocusElement) {
                restoredFocusElement.focus();
                const currentLength = restoredFocusElement.value.length;
                restoredFocusElement.setSelectionRange(currentLength, currentLength);
            }
        }
    }

    async function cargarTodo() {
        // Solo ejecuta las funciones de carga si el usuario es Admin
        if (isAdmin) {
            await Promise.all([cargarPendientes(), cargarEntregadas()]);
        }
    }

    // =============================
    // ¬† FUNCIONES DE COMENTARIO
    // =============================
    window.guardarComentario = async function(id) {
        if (!isAdmin) return alert("Error: No tienes permisos de administrador.");
        const txt = document.getElementById(`coment_${id}`).value.trim();
        if (!txt) return alert("Escribe un comentario primero.");
        const { error } = await supabase
            .from("solicitudes")
            .update({ comentario_entrega: txt })
            .eq("id", id);
        if (error) {
            console.error("Error al guardar comentario:", error);
            alert("Error al guardar el comentario. Verifica tu conexi√≥n o permisos.");
        } else {
            cargarTodo();
        }
    }

    window.guardarSinComentario = async function(id) {
        if (!isAdmin) return alert("Error: No tienes permisos de administrador.");
        const { error } = await supabase
            .from("solicitudes")
            .update({ comentario_entrega: "Sin comentario" })
            .eq("id", id);
        if (error) {
            console.error("Error al guardar comentario:", error);
            alert("Error al guardar el estado. Verifica tu conexi√≥n o permisos.");
        } else {
            cargarTodo();
        }
    }

    // =============================
    // ¬† INICIO DEL PROCESO
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
        checkAdminAccess();
        // El setInterval se inicia dentro de checkAdminAccess() si el rol es 'Admin'
    });
</script>
</body>
</html>
