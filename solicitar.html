<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Solicitud de Materiales</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
    }
    .box {
        background: white;
        padding: 20px;
        max-width: 750px;
        margin: 20px auto;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,0,0,0.15);
    }
    h2, h3 { text-align: center; margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        margin-top: 5px;
        margin-bottom: 15px;
        border-radius: 6px;
        border: 1px solid #aaa;
        box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background: #007bff; color: white; text-align: center; }
    td input { width: 100%; padding: 7px; font-size: 14px; box-sizing: border-box; }
    .btnAdd, .btnRemove, .btnEnviar, .btnVolver {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
    }
    .btnAdd { background: #17a2b8; color: white; }
    .btnRemove { background: #dc3545; color: white; }
    .btnEnviar { background: #28a745; color: white; }
    .btnVolver { background: #6c757d; color: white; }
</style>
</head>
<body>

<div class="box">
    <h2>Solicitud de Materiales</h2>

    <label>Docente a cargo:</label>
    <select id="docente">
        <option value="">Seleccione un docente</option>
        <option>AAR√ìN EDUARDO SEP√öLVEDA MEDINA</option>
        <option>ALEJANDRO GABRIEL MOENA VALDERRAMA</option>
        <option>BRAYAN PATRICIO DEL VALLE AEDO</option>
        <option>DANIELA FERNANDA MART√çNEZ MART√çNEZ</option>
        <option>EDUARDO ARTURO BAST√çAS GARC√çA</option>
        <option>EL√çAS ANDR√âS POBLETE AVILA</option>
        <option>GERARDO NICOL√ÅS SEP√öLVEDA GUTI√âRREZ</option>
        <option>GIOVANNI ANDR√âS JARA TORRES</option>
        <option>JORGE ANDR√âS P√âREZ MILLAR</option>
        <option>JOSEFA CATALINA LISBOA RIVERA</option>
        <option>JULIO CESAR ALARCON MONTEROS</option>
        <option>MANUEL ALEJANDRO HENRIQUEZ OLIVA</option>
        <option>MARCO ANTONIO ARRIAGADA CASAS</option>
        <option>PEDRO PATRICIO PEDRERO P√âREZ</option>
        <option>RICHARD ANTONIO VALDERRAMA SAN MARTIN</option>
        <option>RICHARD NICOL√ÅS SANTOS MART√çNEZ</option>
        <option>ROBERTO SEBASTIAN CID LIZAMA</option>
        <option>RODRIGO ALEJANDRO CONTRERAS Z√ö√ëIGA</option>
        <option>RODRIGO ALEJANDRO GARRIDO GARRIDO</option>
        <option>ROLANDO EDUARDO ORTEGA FUENTES</option>
        <option>V√çCTOR EDUARDO ZAPATA MYRIK</option>
        <option>OTROS DOCENTES</option>
    </select>

    <label>Asignatura:</label>
    <input type="text" id="asignatura" placeholder="Ej: Instalaciones El√©ctricas II">

    <h3>Materiales Solicitados</h3>

    <table id="tabla">
        <thead>
            <tr>
                <th>Material / Equipo</th>
                <th>Cantidad</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td><input type="text" placeholder="Ej: Mult√≠metro UT33C"></td>
                <td><input type="number" min="1" value="1"></td>
            </tr>
        </tbody>
    </table>

    <button class="btnAdd" onclick="addRow()">‚ûï Agregar Material</button>
    <button class="btnRemove" onclick="removeRow()">‚ûñ Eliminar √öltimo</button>
    <button class="btnEnviar" onclick="enviar()">Enviar Solicitud</button>
    <button class="btnVolver" onclick="location.href='menu.html'">Volver</button>
</div>

<script>
/* üîó Conexi√≥n a Supabase IGUAL que en index.html */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user) window.location.href = "index.html";

/* ‚ûï A√±adir fila */
function addRow() {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input type="text" placeholder="Ej: Cables de prueba"></td>
        <td><input type="number" min="1" value="1"></td>`;
    document.getElementById("tbody").appendChild(tr);
}

/* ‚ûñ Eliminar fila */
function removeRow() {
    const tbody = document.getElementById("tbody");
    if (tbody.rows.length > 1) tbody.deleteRow(tbody.rows.length - 1);
    else alert("Debe haber al menos un material.");
}

/* üì§ Enviar Solicitud */
async function enviar() {
    const btn = document.querySelector(".btnEnviar");
    btn.disabled = true;
    btn.innerText = "Enviando...";

    const docente = document.getElementById("docente").value;
    const asignatura = document.getElementById("asignatura").value.trim();
    const filas = document.querySelectorAll("#tbody tr");
    const materiales = [];

    if (!docente) return finishError("Seleccione un docente.");
    if (!asignatura) return finishError("Ingrese la asignatura.");

    filas.forEach(f => {
        const nombre = f.children[0].querySelector("input").value.trim();
        const cantidad = parseInt(f.children[1].querySelector("input").value.trim(), 10);
        if (nombre && cantidad) materiales.push({ material: nombre, cantidad });
    });

    if (materiales.length === 0) return finishError("Debe ingresar al menos un material.");

    try {
        /* 1Ô∏è‚É£ Insertar solicitud */
        const { data: solicitud, error } = await supabaseClient
            .from("solicitudes")
            .insert([{
                email: user.email,
                docente,
                asignatura,
                fecha_solicitud: new Date().toISOString(),
                estado: "Pendiente"
            }])
            .select()
            .single();

        if (error) throw error;

        /* 2Ô∏è‚É£ Insertar materiales */
        for (const m of materiales) {
            const { error } = await supabaseClient
                .from("materiales_solicitados")
                .insert([{ id_solicitud: solicitud.id, material: m.material, cantidad: m.cantidad }]);
            if (error) throw error;
        }

        alert("‚úÖ Solicitud enviada con √©xito.");
        window.location.href = "menu.html";

    } catch (err) {
        console.error(err);
        finishError("Error al enviar: " + err.message);
    }
}

function finishError(msg) {
    alert("‚ùå " + msg);
    const btn = document.querySelector(".btnEnviar");
    btn.disabled = false;
    btn.innerText = "Enviar Solicitud";
}
</script>

</body>
</html>

