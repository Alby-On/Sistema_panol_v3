<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Solicitudes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f4f4f4;
    }

    h2 {
        text-align: center;
        margin-bottom: 10px;
        color: #004d99;
    }

    /* CONTENEDOR PRINCIPAL EN 2 COLUMNAS */
    .contenedor {
        display: flex;
        gap: 20px;
        justify-content: center;
    }

    .columna {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 48%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
    }

    th {
        background: #004d99;
        color: white;
        padding: 10px;
        text-align: left;
    }

    td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    textarea {
        width: 95%;
        min-height: 40px;
    }

    button {
        padding: 5px 10px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
    }

    .btnGuardar {
        background: #17a2b8;
    }

    .btnBorrar {
        background: #dc3545;
    }

</style>
</head>
<body>

<h2>Panel de Solicitudes</h2>

<div class="contenedor">

    <!-- ============================
         COLUMNA 1: SOLICITUDES PENDIENTES
    ============================= -->
    <div class="columna">
        <h3>Solicitudes Pendientes</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody id="tbodyRecientes"></tbody>
        </table>
    </div>

    <!-- ============================
         COLUMNA 2: ENTREGADAS
    ============================= -->
    <div class="columna">
        <h3>Solicitudes Entregadas</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Comentario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyEntregadas"></tbody>
        </table>
    </div>

</div>


<script>
/* ============================================
   CONFIG SUPABASE
=============================================== */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ============================================
   CONTROL LOCAL DE OCULTOS Y EDICIÓN
=============================================== */
let ocultas = [];
let comentarioEnEdicion = null;

/* Detectar si está escribiendo */
document.addEventListener("focusin", e => {
    if (e.target.tagName === "TEXTAREA") {
        comentarioEnEdicion = e.target.id;
    }
});
document.addEventListener("focusout", e => {
    if (e.target.tagName === "TEXTAREA") {
        comentarioEnEdicion = null;
    }
});

/* ============================================
   FETCH PRINCIPAL
=============================================== */
async function fetchSolicitudes() {

    const { data: solicitudes, error } = await supabase
        .from("solicitudes")
        .select("*")
        .order("fecha_solicitud", { ascending: false })
        .limit(50);

    if (error) return console.error(error);

    const pendientes = solicitudes.filter(s => s.estado === "Pendiente");
    const entregadas = solicitudes.filter(s => s.estado === "Entregado");

    renderRecientes(pendientes);

    if (!comentarioEnEdicion) {
        renderEntregadas(entregadas);
    }
}

/* ============================================
   RENDERIZAR PENDIENTES
=============================================== */
function renderRecientes(lista) {
    const tbody = document.getElementById("tbodyRecientes");
    tbody.innerHTML = "";

    lista
        .filter(s => !ocultas.includes(s.id))
        .slice(0, 10)
        .forEach(s => {
            tbody.innerHTML += `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.usuario}</td>
                    <td>${new Date(s.fecha_solicitud).toLocaleString()}</td>
                </tr>
            `;
        });
}

/* ============================================
   RENDERIZAR ENTREGADAS
=============================================== */
function renderEntregadas(lista) {
    const tbody = document.getElementById("tbodyEntregadas");
    tbody.innerHTML = "";

    lista
        .filter(s => !ocultas.includes(s.id))
        .slice(0, 20)
        .forEach(s => {
            tbody.innerHTML += `
                <tr id="fila-${s.id}">
                    <td>${s.id}</td>
                    <td>${s.usuario}</td>
                    <td>
                        <textarea id="comentario-${s.id}">${s.comentario_entrega || ""}</textarea>
                    </td>
                    <td>
                        <button class="btnGuardar" onclick="guardarComentario(${s.id})">Guardar</button>
                        <button class="btnBorrar" onclick="ocultar(${s.id})">Borrar</button>
                    </td>
                </tr>
            `;
        });
}

/* ============================================
   GUARDAR COMENTARIO Y OCULTAR
=============================================== */
async function guardarComentario(id) {
    let comentario = document.getElementById(`comentario-${id}`).value.trim();
    if (comentario === "") comentario = "Sin Comentarios";

    await supabase
        .from("solicitudes")
        .update({ comentario_entrega: comentario })
        .eq("id", id);

    ocultar(id); 
}

/* ============================================
   OCULTAR SOLO EN PANTALLA
=============================================== */
function ocultar(id) {
    if (!ocultas.includes(id)) {
        ocultas.push(id);
        localStorage.setItem("ocultas", JSON.stringify(ocultas));
    }

    const fila = document.getElementById(`fila-${id}`);
    if (fila) fila.remove();
}

/* ============================================
   AUTO-UPDATE CADA 5 SEG
=============================================== */
setInterval(fetchSolicitudes, 5000);
fetchSolicitudes();

</script>

</body>
</html>

