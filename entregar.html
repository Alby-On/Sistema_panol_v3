<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Entregar Materiales</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    .box { background: white; padding: 20px; max-width: 900px; margin: auto; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.15); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background: #007bff; color: white; }
    button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btnVer { background: #17a2b8; color: white; }
    .btnEntregar { background: #28a745; color: white; margin-top: 10px; }
</style>
</head>

<body>
<div class="box">
    <h2>Entregar Materiales</h2>
    <div id="listaSolicitudes"></div>
    <hr>
    <h3>Detalles de la Solicitud</h3>
    <div id="detalles"></div>
</div>

<script>
/* üîó Conexi√≥n Supabase */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* üü¶ Validar usuario */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user) window.location.href = "index.html";

window.onload = cargarSolicitudes;

/* üü© Cargar solicitudes del usuario */
async function cargarSolicitudes() {
    const cont = document.getElementById("listaSolicitudes");
    cont.innerHTML = "<p>Cargando solicitudes...</p>";

    const { data, error } = await supabaseClient
        .from("solicitudes")
        .select("*")
        .eq("email", user.email)
        .order("id", { ascending: false });

    if (error) {
        cont.innerHTML = "‚ùå Error al cargar solicitudes.";
        return;
    }

    if (data.length === 0) {
        cont.innerHTML = "<p>No hay solicitudes registradas.</p>";
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Docente</th>
                    <th>Asignatura</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(s => {
        html += `
            <tr>
                <td>${s.id}</td>
                <td>${s.docente}</td>
                <td>${s.asignatura}</td>
                <td>${new Date(s.fecha_solicitud).toLocaleString()}</td>
                <td>${s.estado}</td>
                <td><button class="btnVer" onclick="verDetalles(${s.id})">Ver detalles</button></td>
            </tr>
        `;
    });

    html += "</tbody></table>";
    cont.innerHTML = html;
}

/* üüß Ver detalles de una solicitud */
async function verDetalles(id_solicitud) {
    const det = document.getElementById("detalles");
    det.innerHTML = "<p>Cargando...</p>";

    const { data: solicitud, error: err1 } = await supabaseClient
        .from("solicitudes")
        .select("*")
        .eq("id", id_solicitud)
        .single();

    const { data: materiales, error: err2 } = await supabaseClient
        .from("materiales_solicitados")
        .select("*")
        .eq("id_solicitud", id_solicitud);

    if (err1 || err2) {
        det.innerHTML = "‚ùå Error al cargar detalles.";
        return;
    }

    let html = `
        <p><strong>ID:</strong> ${solicitud.id}</p>
        <p><strong>Docente:</strong> ${solicitud.docente}</p>
        <p><strong>Asignatura:</strong> ${solicitud.asignatura}</p>
        <p><strong>Fecha Solicitud:</strong> ${new Date(solicitud.fecha_solicitud).toLocaleString()}</p>
        <p><strong>Estado:</strong> ${solicitud.estado}</p>

        <h4>Materiales Solicitados</h4>
        <table>
            <thead>
                <tr><th>Material</th><th>Cantidad</th></tr>
            </thead>
            <tbody>
    `;

    materiales.forEach(m => {
        html += `<tr><td>${m.material}</td><td>${m.cantidad}</td></tr>`;
    });

    html += `
            </tbody>
        </table>
        <button class="btnEntregar" onclick="entregar(${solicitud.id})">Marcar como ENTREGADO</button>
    `;

    det.innerHTML = html;
}

/* üü© ENTREGAR solicitud */
async function entregar(id_solicitud) {

    if (!confirm("¬øConfirmar entrega de esta solicitud?")) return;

    const { error } = await supabaseClient
        .from("solicitudes")
        .update({
            estado: "Entregado",
            fecha_entrega: new Date().toISOString()
        })
        .eq("id", Number(id_solicitud));  // üî• Fix cr√≠tico

    if (error) {
        alert("‚ùå Error al registrar entrega");
        return;
    }

    alert("‚úÖ Entrega registrada correctamente.");
    cargarSolicitudes();
    document.getElementById("detalles").innerHTML = "";

}
</script>

</body>
</html>


