<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Entregar Materiales</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
        const SUPABASE_KEY = "TU_API_KEY_AQUI";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener("DOMContentLoaded", () => {
            const email = localStorage.getItem("email");

            if (!email) {
                alert("Debe iniciar sesión para continuar");
                window.location.href = "login.html";
                return;
            }

            cargarSolicitudesPendientes(email);
        });

        async function cargarSolicitudesPendientes(emailUsuario) {
            const contenedor = document.getElementById("contenedor");

            contenedor.innerHTML = "<p>Cargando solicitudes...</p>";

            const { data: solicitudes, error } = await supabaseClient
                .from("solicitudes")
                .select("*")
                .eq("estado", "Pendiente")
                .eq("email", emailUsuario);   // FILTRO POR USUARIO LOGEADO

            if (error) {
                contenedor.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
                return;
            }

            if (!solicitudes || solicitudes.length === 0) {
                contenedor.innerHTML = "<p>No hay solicitudes pendientes.</p>";
                return;
            }

            contenedor.innerHTML = "";

            for (const sol of solicitudes) {
                const div = document.createElement("div");
                div.classList.add("solicitud");

                div.innerHTML = `
                    <h3>Solicitud #${sol.id}</h3>
                    <p><strong>Docente:</strong> ${sol.docente}</p>
                    <p><strong>Asignatura:</strong> ${sol.asignatura}</p>
                    <p><strong>Fecha Solicitud:</strong> ${sol.fecha}</p>

                    <h4>Materiales solicitados:</h4>
                    <div id="materiales-${sol.id}">Cargando materiales...</div>
                    <hr>
                `;

                contenedor.appendChild(div);

                cargarMateriales(sol.id);
            }
        }

        async function cargarMateriales(idSolicitud) {
            const divMat = document.getElementById(`materiales-${idSolicitud}`);

            const { data: materiales, error } = await supabaseClient
                .from("materiales_solicitados")
                .select("*")
                .eq("id_solicitud", idSolicitud);

            if (error) {
                divMat.innerHTML = `<p style="color:red">Error al cargar materiales</p>`;
                return;
            }

            if (!materiales || materiales.length === 0) {
                divMat.innerHTML = "<p>No hay materiales para esta solicitud.</p>";
                return;
            }

            let html = "<ul>";

            materiales.forEach(mat => {
                html += `
                    <li>
                        ${mat.material} — Cant: ${mat.cantidad}<br>
                        ${mat.fecha_entrega ? 
                            `<span style="color:green">✔ Entregado el ${mat.fecha_entrega}</span>` :
                            `<button onclick="entregarMaterial(${mat.id}, ${idSolicitud})">Entregar</button>`
                        }
                    </li><br>
                `;
            });

            html += "</ul>";

            divMat.innerHTML = html;
        }

        async function entregarMaterial(idMaterial, idSolicitud) {
            const fecha = new Date().toISOString();

            const { error } = await supabaseClient
                .from("materiales_solicitados")
                .update({ fecha_entrega: fecha })
                .eq("id", idMaterial);

            if (error) {
                alert("Error entregando material");
                return;
            }

            cargarMateriales(idSolicitud);
            revisarSolicitudCompletada(idSolicitud);
        }

        async function revisarSolicitudCompletada(idSolicitud) {
            const { data: materiales, error } = await supabaseClient
                .from("materiales_solicitados")
                .select("fecha_entrega")
                .eq("id_solicitud", idSolicitud);

            if (error) return;

            const pendientes = materiales.some(m => m.fecha_entrega === null);

            if (!pendientes) {
                await supabaseClient
                    .from("solicitudes")
                    .update({ estado: "Entregado" })
                    .eq("id", idSolicitud);

                const email = localStorage.getItem("email");
                cargarSolicitudesPendientes(email);
            }
        }

    </script>

    <style>
        body { font-family: Arial; padding: 20px; }
        .solicitud {
            background: #f0f0f0;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        button {
            padding: 6px 10px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

<h1>Entregar materiales</h1>

<div id="contenedor"></div>

</body>
</html>
