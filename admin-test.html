<!DOCTYPE html>
<html lang="es">
<head>
ย <meta charset="UTF-8" />
ย <meta name="viewport" content="width=device-width, initial-scale=1.0" />
ย <title>Panel de Solicitudes</title>

ย ย <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

ย ย <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 p-4 md:p-8 font-sans">
ย <header class="max-w-7xl mx-auto mb-8">
ย ย <h1 class="text-4xl font-extrabold text-gray-800 text-center border-b-2 border-gray-200 pb-3">
ย ย ย ๐ Panel de Gestiรณn de Materiales
ย ย </h1>
ย </header>

ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-7xl mx-auto">
ย ย 
ย ย ย ย <div class="bg-white shadow-xl rounded-2xl border-t-4 border-yellow-500 overflow-hidden">
ย ย ย <div class="bg-yellow-50 p-4 border-b border-yellow-200">
ย ย ย ย <h2 class="text-2xl font-bold text-yellow-700">โณ Solicitudes Pendientes</h2>
ย ย ย ย ย ย ย </div>
ย ย ย <div id="listaPendientes" class="p-4 space-y-5 max-h-[80vh] overflow-y-auto"></div>
ย ย </div>

ย ย ย ย <div class="bg-white shadow-xl rounded-2xl border-t-4 border-green-600 overflow-hidden">
ย ย ย <div class="bg-green-50 p-4 border-b border-green-200">
ย ย ย ย <h2 class="text-2xl font-bold text-green-700">โ Entregadas (Sin Comentario)</h2>
ย ย ย </div>
ย ย ย <div id="listaEntregadas" class="p-4 space-y-5 max-h-[80vh] overflow-y-auto"></div>
ย ย </div>

ย </div>

<script>
ย ย // =============================
ย ย //ย ยCONFIGURAR SUPABASE (LรGICA INTACTA)
ย ย // =============================
ย ย const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
ย ย const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

ย ย const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

ย ย // =============================
ย ย //ย ยEJECUTAR CUANDO DOM ESTร LISTO (LรGICA INTACTA)
ย ย // =============================
ย ย document.addEventListener("DOMContentLoaded", () => {

ย ย ย ย // =================================
ย ย ย ย //ย ยCREAR TARJETAS (MEJORAS VISUALES)
ย ย ย ย // =================================
ย ย ย ย function crearCardPendiente(s, materiales) {
ย ย ย ย ย ย // Estilo mejorado para la lista de materiales
ย ย ย ย ย ย const materialesHTML = materiales.map(m => 
ย ย ย ย ย ย ย ย `<li class="text-gray-700">${m.material} <span class="font-semibold text-gray-800">(${m.cantidad} ud)</span></li>`
ย ย ย ย ย ย ).join("");
ย ย ย ย ย ยย
ย ย ย ย ย ย // Lรณgica de la uniรณn (INTACTA)
ย ย ย ย ย ย const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
ย ย ย ย ย ยย
ย ย ย ย ย ย return `
ย ย ย ย ย ย ย <div id="solicitud_${s.id}" class="bg-white border border-gray-200 rounded-lg p-5 shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.01]">
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-4 border-b pb-3 border-yellow-200">
ย ย ย ย ย ย ย ย ย <span class="text-sm font-mono text-yellow-700 bg-yellow-100 px-3 py-1 rounded-full font-bold">
ย ย ย ย ย ย ย ย ย ย SOLICITUD #${s.id}
ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="space-y-2 text-sm text-gray-700">
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐ฅ Solicitante:</span> ${nombreSolicitante}</p>
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐จโ๐ซ Docente:</span> ${s.docente}</p>
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐ Asignatura:</span> ${s.asignatura}</p>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-4 pt-4 border-t border-gray-100">
ย ย ย ย ย ย ย ย ย <p class="font-bold text-gray-800 mb-2">๐ฆ Materiales Requeridos:</p>
ย ย ย ย ย ย ย ย ย <ul class="ml-4 space-y-1 list-disc text-sm text-gray-600">
ย ย ย ย ย ย ย ย ย ย ${materialesHTML}
ย ย ย ย ย ย ย ย ย </ul>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย }

ย ย ย ย function crearCardEntregada(s, materiales) {
ย ย ย ย ย ย // Estilo mejorado para la lista de materiales
ย ย ย ย ย ย const materialesHTML = materiales.map(m => 
ย ย ย ย ย ย ย ย `<li class="text-gray-700">${m.material} <span class="font-semibold text-gray-800">(${m.cantidad} ud)</span></li>`
ย ย ย ย ย ย ).join("");
ย ย ย ย ย ยย
ย ย ย ย ย ย // Lรณgica de la uniรณn (INTACTA)
ย ย ย ย ย ย const nombreSolicitante = s.usuarios ? s.usuarios.nombre : 'N/A';
ย ย ย ย ย ยย
ย ย ย ย ย ย return `
ย ย ย ย ย ย ย <div id="solicitud_${s.id}" class="bg-white border border-gray-200 rounded-lg p-5 shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.01]">
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-4 border-b pb-3 border-green-200">
ย ย ย ย ย ย ย ย ย <span class="text-sm font-mono text-green-700 bg-green-100 px-3 py-1 rounded-full font-bold">
ย ย ย ย ย ย ย ย ย ย SOLICITUD #${s.id}
ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="space-y-2 text-sm text-gray-700 mb-4">
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐ฅ Solicitante:</span> ${nombreSolicitante}</p>
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐จโ๐ซ Docente:</span> ${s.docente}</p>
ย ย ย ย ย ย ย ย ย <p><span class="font-bold text-gray-900">๐ Asignatura:</span> ${s.asignatura}</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-4 pt-4 border-t border-gray-100">
ย ย ย ย ย ย ย ย ย <p class="font-bold text-gray-800 mb-2">โ Materiales Entregados:</p>
ย ย ย ย ย ย ย ย ย <ul class="ml-4 space-y-1 list-disc text-sm text-gray-600">
ย ย ย ย ย ย ย ย ย ย ${materialesHTML}
ย ย ย ย ย ย ย ย ย </ul>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-xl">
ย ย ย ย ย ย ย ย ย <p class="text-sm font-bold text-gray-700 mb-2">๐ Registrar Comentario de Entrega:</p>
ย ย ย ย ย ย ย ย ย <textarea id="coment_${s.id}" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500 resize-none" placeholder="Escribe un comentario o nota final..."></textarea>
ย ย ย ย ย ย ย ย ย <div class="flex justify-end gap-3 mt-3">
ย ย ย ย ย ย ย ย ย ย <button onclick="guardarSinComentario(${s.id})"
ย ย ย ย ย ย ย ย ย ย ย class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm font-semibold hover:bg-gray-600 transition duration-150">
ย ย ย ย ย ย ย ย ย ย ย Sin comentario
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="guardarComentario(${s.id})"
ย ย ย ย ย ย ย ย ย ย ย class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition duration-150">
ย ย ย ย ย ย ย ย ย ย ย Enviar comentario
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย }

ย ย ย ย // =============================
ย ย ย ย //ย ยCARGAR LISTAS (LรGICA INTACTA)
ย ย ย ย // =============================
ย ย ย ย // *** Las funciones cargarPendientes y cargarEntregadas mantienen su lรณgica interna, ***
ย ย ย ย // *** pero ahora llaman a las funciones crearCard... visualmente mejoradas. ***

ย ย ย ย async function cargarPendientes() {
ย ย ย ย ย ย const cont = document.getElementById("listaPendientes");
ย ย ย ย ย ยย
ย ย ย ย ย ย const { data: solicitudes } = await supabase
ย ย ย ย ย ย ย ย .from("solicitudes")
ย ย ย ย ย ย ย ย .select("*, usuarios(nombre)")ย
ย ย ย ย ย ย ย ย .eq("estado", "Pendiente")
ย ย ย ย ย ย ย ย .order("id", { ascending: false });

ย ย ย ย ย ย let html = '';
ย ย ย ย ย ย for (const s of solicitudes) {
ย ย ย ย ย ย ย ย const { data: materiales } = await supabase
ย ย ย ย ย ย ย ย ย ย .from("materiales_solicitados")
ย ย ย ย ย ย ย ย ย ย .select("*")
ย ย ย ย ย ย ย ย ย ย .eq("id_solicitud", s.id);
ย ย ย ย ย ย ย ย html += crearCardPendiente(s, materiales);
ย ย ย ย ย ย }
ย ย ย ย ย ย cont.innerHTML = html;
ย ย ย ย }

ย ย ย ย async function cargarEntregadas() {
ย ย ย ย ย ย const cont = document.getElementById("listaEntregadas");
ย ย ย ย ย ย const comentariosGuardados = {};
ย ย ย ย ย ยย
ย ย ย ย ย ย let focusedElementId = document.activeElement && document.activeElement.tagName === 'TEXTAREA' ? document.activeElement.id : null;
ย ย ย ย ย ย document.querySelectorAll("#listaEntregadas textarea").forEach(textarea => {
ย ย ย ย ย ย ย ย const id = textarea.id.replace("coment_", "");
ย ย ย ย ย ย ย ย comentariosGuardados[id] = textarea.value;
ย ย ย ย ย ย });

ย ย ย ย ย ย const { data: solicitudes } = await supabase
ย ย ย ย ย ย ย ย .from("solicitudes")
ย ย ย ย ย ย ย ย .select("*, usuarios(nombre)")ย
ย ย ย ย ย ย ย ย .eq("estado", "Entregado")
ย ย ย ย ย ย ย ย .is("comentario_entrega", null)
ย ย ย ย ย ย ย ย .order("id", { ascending: false });

ย ย ย ย ย ย let nuevoHtml = "";
ย ย ย ย ย ย for (const s of solicitudes) {
ย ย ย ย ย ย ย ย const { data: materiales } = await supabase
ย ย ย ย ย ย ย ย ย ย .from("materiales_solicitados")
ย ย ย ย ย ย ย ย ย ย .select("*")
ย ย ย ย ย ย ย ย ย ย .eq("id_solicitud", s.id);
ย ย ย ย ย ย ย ย nuevoHtml += crearCardEntregada(s, materiales);
ย ย ย ย ย ย }

ย ย ย ย ย ย cont.innerHTML = nuevoHtml;
ย ย ย ย ย ย 
ย ย ย ย ย ย solicitudes.forEach(s => {
ย ย ย ย ย ย ย ย const id = s.id.toString();
ย ย ย ย ย ย ย ย if (comentariosGuardados[id]) {
ย ย ย ย ย ย ย ย ย ย const textarea = document.getElementById(`coment_${id}`);
ย ย ย ย ย ย ย ย ย ย if (textarea) {
ย ย ย ย ย ย ย ย ย ย ย ย textarea.value = comentariosGuardados[id];
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย if (focusedElementId) {
ย ย ย ย ย ย ย ย const restoredFocusElement = document.getElementById(focusedElementId);
ย ย ย ย ย ย ย ย if (restoredFocusElement) {
ย ย ย ย ย ย ย ย ย ย restoredFocusElement.focus();
ย ย ย ย ย ย ย ย ย ย const currentLength = restoredFocusElement.value.length;
ย ย ย ย ย ย ย ย ย ย restoredFocusElement.setSelectionRange(currentLength, currentLength);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย async function cargarTodo() {
ย ย ย ย ย ย await cargarPendientes();
ย ย ย ย ย ย await cargarEntregadas();
ย ย ย ย }

ย ย ย ย // =============================
ย ย ย ย //ย FUNCIONES DE COMENTARIO (LรGICA INTACTA)
ย ย ย ย // =============================
ย ย ย ย window.guardarComentario = async function(id) {
ย ย ย ย ย ย const txt = document.getElementById(`coment_${id}`).value.trim();
ย ย ย ย ย ย if (!txt) return alert("Escribe un comentario primero.");
ย ย ย ย ย ย await supabase
ย ย ย ย ย ย ย ย .from("solicitudes")
ย ย ย ย ย ย ย ย .update({ comentario_entrega: txt })
ย ย ย ย ย ย ย ย .eq("id", id);
ย ย ย ย ย ย cargarTodo();
ย ย ย ย }

ย ย ย ย window.guardarSinComentario = async function(id) {
ย ย ย ย ย ย await supabase
ย ย ย ย ย ย ย ย .from("solicitudes")
ย ย ย ย ย ย ย ย .update({ comentario_entrega: "Sin comentario" })
ย ย ย ย ย ย ย ย .eq("id", id);
ย ย ย ย ย ย cargarTodo();
ย ย ย ย }

ย ย ย ย // =============================
ย ย ย ย //ย ยAUTO-ACTUALIZACIรN 5s (LรGICA INTACTA)
ย ย ย ย // =============================
ย ย ย ย cargarTodo();
ย ย ย ย setInterval(cargarTodo, 5000);

ย ย }); // fin DOMContentLoaded
</script>
</body>
</html>
