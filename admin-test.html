<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Visualización</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        padding: 20px;
    }

    h2 {
        margin-top: 40px;
        color: #333;
    }

    .card {
        background: white;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .material {
        background: #eef2ff;
        padding: 5px 10px;
        border-radius: 5px;
        margin: 3px 0;
    }

    textarea {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        resize: vertical;
    }

    button {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 8px;
    }
</style>
</head>

<body>

<h2>Últimas 5 Solicitudes</h2>
<div id="solicitudes"></div>

<h2>Entregas Pendientes de Comentario</h2>
<div id="entregas"></div>

<script>
const supabase = supabase.createClient("TU_URL", "TU_ANON_KEY");

// Cargar últimas 5 solicitudes
async function cargarSolicitudes() {
    const { data: solicitudes } = await supabase
        .from("solicitudes")
        .select("*")
        .order("id", { ascending: false })
        .limit(5);

    const cont = document.getElementById("solicitudes");
    cont.innerHTML = "";

    for (const sol of solicitudes) {
        // Buscar materiales de esta solicitud
        const { data: materiales } = await supabase
            .from("materiales_solicitud")
            .select("*")
            .eq("solicitud_id", sol.id);

        let card = `
        <div class="card">
            <strong>ID Solicitud:</strong> ${sol.id}<br>
            <strong>Usuario:</strong> ${sol.usuario}<br>
            <strong>Fecha:</strong> ${new Date(sol.fecha).toLocaleString()}<br>
            <strong>Materiales:</strong><br>
        `;

        materiales.forEach(m => {
            card += `<div class="material">${m.material} — ${m.cantidad}</div>`;
        });

        card += `</div>`;
        cont.innerHTML += card;
    }
}

// Cargar entregas que no tienen comentario
async function cargarEntregas() {
    const { data: entregas } = await supabase
        .from("solicitudes")
        .select("*")
        .eq("estado", "entregado")
        .is("comentario_recepcion", null);

    const cont = document.getElementById("entregas");
    cont.innerHTML = "";

    entregas.forEach(ent => {
        cont.innerHTML += `
        <div class="card">
            <strong>ID Solicitud:</strong> ${ent.id}<br>
            <strong>Usuario:</strong> ${ent.usuario}<br>
            <strong>Fecha:</strong> ${new Date(ent.fecha).toLocaleString()}<br>

            <strong>Comentario de Recepción:</strong><br>
            <textarea id="comentario_${ent.id}" placeholder="Escribe un comentario..."></textarea>
            <button onclick="guardarComentario(${ent.id})">Guardar Comentario</button>
        </div>
        `;
    });
}

// Guardar comentario en la BD
async function guardarComentario(id) {
    let comentario = document.getElementById(`comentario_${id}`).value;

    const { error } = await supabase
        .from("solicitudes")
        .update({ comentario_recepcion: comentario })
        .eq("id", id);

    if (!error) {
        alert("Comentario guardado correctamente.");
        cargarEntregas(); // actualizar la lista
    } else {
        alert("Error al guardar el comentario.");
    }
}

// Ejecutar al cargar
cargarSolicitudes();
cargarEntregas();

// Refrescar cada 20 segundos automáticamente
setInterval(() => {
    cargarSolicitudes();
    cargarEntregas();
}, 20000);
</script>

</body>
</html>

