<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Entregar Materiales</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Entregar Materiales</h1>

<!-- Contenedor para mostrar solicitudes -->
<div id="listaSolicitudes"></div>

<script>
    // Inicializar Supabase
    const supabaseClient = supabase.createClient(
        "https://lzspjrbmhdxbuyqiysxm.supabase.co",
        "public-anon-key"
    );

    // ‚õî **YA NO VALIDAMOS LOGIN**
    // Antes aqu√≠ se revisaba el usuario, pero fue eliminado.

    // Obtener ID del usuario desde localStorage si existe
    const userId = localStorage.getItem("user_id") || "";  
    console.log("Usuario logueado (solo si existe):", userId);

    // ----------------------------------------------------------
    // Cargar solicitudes (sin login obligatorio)
    // ----------------------------------------------------------
    async function cargarSolicitudes() {
        console.log("üîÑ Cargando solicitudes...");

        let query = supabaseClient
            .from("solicitudes")
            .select("id, nombre_material, cantidad, estado, user_id");

        // Si existe un user_id, filtramos
        if (userId !== "") {
            query = query.eq("user_id", userId);
            console.log("Aplicando filtro por usuario:", userId);
        } else {
            console.log("No existe user_id ‚Üí No se aplica filtro");
        }

        const { data, error } = await query;

        if (error) {
            console.error("‚ùå Error cargando solicitudes:", error);
            return;
        }

        mostrarSolicitudes(data);
    }

    // ----------------------------------------------------------
    // Mostrar solicitudes en pantalla
    // ----------------------------------------------------------
    function mostrarSolicitudes(lista) {
        const contenedor = document.getElementById("listaSolicitudes");
        contenedor.innerHTML = "";

        if (lista.length === 0) {
            contenedor.innerHTML = "<p>No hay solicitudes.</p>";
            return;
        }

        lista.forEach(item => {
            const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.margin = "10px";
            div.style.padding = "10px";

            div.innerHTML = `
                <p><strong>Material:</strong> ${item.nombre_material}</p>
                <p><strong>Cantidad:</strong> ${item.cantidad}</p>
                <p><strong>Estado:</strong> ${item.estado}</p>
                <button onclick="entregar(${item.id})">Entregar</button>
            `;

            contenedor.appendChild(div);
        });
    }

    // ----------------------------------------------------------
    // Funci√≥n entregar
    // ----------------------------------------------------------
    async function entregar(idSolicitud) {
        const { error } = await supabaseClient
            .from("solicitudes")
            .update({ estado: "Entregado" })
            .eq("id", idSolicitud);

        if (error) {
            alert("‚ùå Error al entregar material");
            console.log(error);
            return;
        }

        alert("‚úîÔ∏è Material entregado");
        cargarSolicitudes(); // recargar lista
    }

    // Cargar solicitudes al iniciar
    cargarSolicitudes();
</script>

</body>
</html>

