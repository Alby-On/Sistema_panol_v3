<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Solicitud de Materiales - Inicio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
.box { background: white; padding: 20px; max-width: 450px; margin: 20px auto; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.15); }
h2,h3 { text-align:center; margin-bottom:15px; }
input, select { width:100%; padding:12px; margin:8px 0 15px; border-radius:7px; border:1px solid #aaa; font-size:16px; box-sizing:border-box; }
button { width:100%; padding:12px; border:none; border-radius:7px; font-size:16px; cursor:pointer; margin-top:10px; }
button:hover { opacity:0.9; }
.btn-primary { background: #007bff; color:white; }
.btn-success { background:#28a745; color:white; }
.hidden { display:none; }
.error { color:red; font-size:14px; margin-bottom:10px; }
</style>
</head>
<body>

<div class="box" id="welcomeBox">
    <h2>Bienvenido(a)</h2>
    <p>Plataforma de <b>solicitud de materiales</b>.</p>
    <button class="btn-primary" onclick="showLogin()">Iniciar Sesión</button>
    <button class="btn-success" onclick="showRegister()">Registrarse</button>
</div>

<div class="box hidden" id="loginBox">
    <h2>Iniciar Sesión</h2>
    <input type="email" placeholder="Correo" id="loginEmail">
    <input type="password" placeholder="Contraseña" id="loginPass">
    <button class="btn-primary" onclick="login()">Ingresar</button>
    <p><a onclick="showRegister()">Registrarme</a></p>
    <p><a onclick="showWelcome()">Volver</a></p>
</div>

<div class="box hidden" id="registerBox">
    <h2>Registro</h2>
    <input type="text" id="regNombre" placeholder="Nombre Completo">
    <input type="text" id="regRut" placeholder="RUT (Ej: 12.345.678-5)">
    <p id="rutError" class="error"></p>
    <select id="regCarrera">
        <option value="">Seleccione una carrera</option>
        <option>Ingeniería Eléctrica</option>
        <option>Ingeniería en Automatización</option>
    </select>
    <input type="tel" id="regTelefono" placeholder="Teléfono (Ej: +56911111111)">
    <input type="email" id="regEmail" placeholder="Correo">
    <input type="password" id="regPass" placeholder="Contraseña">
    <button class="btn-success" onclick="registrar()">Crear Cuenta</button>
    <p><a onclick="showLogin()">Ya tengo cuenta</a></p>
    <p><a onclick="showWelcome()">Volver</a></p>
</div>

<!-- ✅ SDK UMD -->
https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.33.0/dist/umd/supabase.min.js

<!-- ✅ Tu código después del SDK -->
<script>
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Pantallas */
function hideAll(){ welcomeBox.classList.add("hidden"); loginBox.classList.add("hidden"); registerBox.classList.add("hidden"); }
function showWelcome(){ hideAll(); welcomeBox.classList.remove("hidden"); }
function showLogin(){ hideAll(); loginBox.classList.remove("hidden"); }
function showRegister(){ hideAll(); registerBox.classList.remove("hidden"); }

/* Validación RUT */
function limpiarRut(rut){ return rut.replace(/\./g,'').replace(/\s/g,'').toUpperCase(); }
function dvT(rut){ let M=0,S=1; for(;rut;rut=Math.floor(rut/10)) S=(S+rut%10*(9-M++%6))%11; return S?S-1:"K"; }
function validarRutCompleto(rutCompleto){ if(!rutCompleto)return{ok:false,msg:"Debe ingresar un RUT."}; const r=limpiarRut(rutCompleto); if(!r.includes("-"))return{ok:false,msg:"El RUT debe contener guion."}; const[num,dv]=r.split("-"); if(!/^\d+$/.test(num))return{ok:false,msg:"La parte numérica debe ser solo números."}; return{ok:dvT(parseInt(num,10)).toString()===dv.toUpperCase()}; }
function clearRutError(){ rutError.textContent=""; }

/* Registro */
async function registrar(){
    clearRutError();
    const nombre=regNombre.value.trim(),rut=regRut.value.trim(),carrera=regCarrera.value,telefono=regTelefono.value.trim(),email=regEmail.value.trim(),pass=regPass.value.trim();
    if(!nombre||!rut||!carrera||!telefono||!email||!pass){ alert("Complete todos los campos."); return; }
    const rutVal=validarRutCompleto(rut); if(!rutVal.ok){ rutError.textContent=rutVal.msg; return; }
    if(!/^\+569\d{8}$/.test(telefono)){ alert("Teléfono inválido."); return; }
    const {data:usuarios}=await supabaseClient.from('usuarios').select('*').or(`rut.eq.${rut},email.eq.${email}`);
    if(usuarios.length>0){ alert("El RUT o correo ya está registrado."); return; }
    const {error}=await supabaseClient.from('usuarios').insert([{nombre,rut,carrera,telefono,email,pass}]);
    if(error){ alert("Error al registrar: "+error.message); return; }
    alert("✅ Registro exitoso."); showLogin();
}

/* Login */
async function login(){
    const email=loginEmail.value.trim(),pass=loginPass.value.trim();
    if(!email||!pass){ alert("Complete todos los campos."); return; }
    const {data:user,error}=await supabaseClient.from('usuarios').select('*').eq('email',email).eq('pass',pass).single();
    if(error||!user){ alert("Correo o contraseña incorrectos."); return; }
    localStorage.setItem("currentUser",JSON.stringify(user));
    window.location.href="menu.html";
}

showWelcome();
</script>
</body>
</html>
