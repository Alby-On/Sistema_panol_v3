<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración INACAP</title>
    
    <style>
        /* Tipografía y Base */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Banner Superior (INACAP) */
        header {
            background-color: #173753; /* Azul Oscuro Corporativo */
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex; /* Habilita Flexbox para alinear elementos */
            justify-content: space-between; /* Mueve elementos a los extremos */
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
        }

        .header-info {
            text-align: right;
        }

        .header-info h2 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .header-info p {
            font-size: 0.9em;
            margin: 5px 0 0;
            color: #b0c4de;
        }

        /* Contenedor Principal (Donde va el botón y el dashboard) */
        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Botón Volver al Menú */
        .back-button-container {
            margin-bottom: 20px;
        }

        .btn-menu {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            text-decoration: none; /* Quita el subrayado del link */
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex; /* Permite ícono y texto */
            align-items: center;
        }

        .btn-menu:hover {
            background-color: #0056b3;
        }

        .btn-menu span {
            margin-right: 8px;
        }

        /* Estructura de Columnas */
        .dashboard-container {
            display: flex;
            gap: 25px;
        }

        .column {
            flex: 1;
        }

        .column h2 {
            font-size: 1.5em;
            color: #173753;
            margin-bottom: 20px;
            padding-left: 5px;
            border-bottom: 2px solid #e1e4e8;
            padding-bottom: 5px;
        }

        /* Estilos de Tarjetas */
        .request-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease-in-out;
            border: 1px solid #f0f2f5;
        }
        
        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Diferenciación visual de tarjetas */
        .pending-requests .request-card {
            border-left: 5px solid #ff9800; /* Naranja para Pendientes */
        }
        .delivered-requests .request-card {
            border-left: 5px solid #4caf50; /* Verde para Entregadas */
        }

        /* Contenido y Etiquetas */
        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }

        .card-header strong {
            font-size: 1.2em;
            color: #007bff;
        }

        .card-detail {
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .card-detail label {
            font-weight: 600;
            color: #555;
            display: inline-block;
            width: 85px;
            vertical-align: top;
        }
        
        /* BLOQUE PARA MATERIALES (Flexbox) - Alineado perfectamente */
        .material-block {
            display: flex;
            align-items: flex-start;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dotted #f0f0f0;
        }

        .material-block label {
            flex-shrink: 0;
            width: 85px; 
        }

        .material-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .material-list li {
            margin-bottom: 2px;
            font-size: 0.9em;
        }
        
        .material-list li:before { 
            content: "•";
            color: #888;
            display: inline-block;
            width: 1em;
            margin-right: 0.2em;
        }

        .card-status-pending {
            color: #ff9800; 
            font-weight: 700;
        }

        .card-status-delivered {
            color: #4caf50; 
            font-weight: 700;
        }
        
        /* Estilos de Acciones (Botones) */
        .actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .actions button {
            padding: 8px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: background-color 0.2s, transform 0.1s;
        }

        .actions button:active {
            transform: scale(0.98);
        }

        .btn-comment {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .btn-comment:hover {
            background-color: #0056b3;
        }

        .btn-no-comment {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
        }

        .btn-no-comment:hover {
            background-color: #ced4da;
        }
        
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header>
        <div class="header-title">
            <h1>Panel de Administrador</h1>
        </div>
        <div class="header-info">
            <h2>INACAP</h2>
            <p>Área Energía, Electrónica, Automatización y Robótica</p>
        </div>
    </header>

    <div class="main-content">
        <div class="back-button-container">
            <a href="menu.html" class="btn-menu">
                <span>&#x2190;</span> Volver al Menú
            </a>
        </div>

        <div class="dashboard-container">
            
            <div class="column pending-requests">
                <h2>⏳ Solicitudes Pendientes</h2>
                <div id="pending-container">
                    <p>Cargando solicitudes...</p>
                </div>
            </div>

            <div class="column delivered-requests">
                <h2>✅ Solicitudes Entregadas</h2>
                <div id="delivered-container">
                    <p>Cargando solicitudes...</p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE SUPABASE
        const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwZzNv6YdJbBsRY";

        // Aquí el objeto Supabase ya está definido
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Contenedores DOM
        const pendingContainer = document.getElementById('pending-container');
        const deliveredContainer = document.getElementById('delivered-container');

        // Función auxiliar para formatear fechas
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES'); 
        };

        // Función para crear el HTML de una tarjeta (Card)
        const createRequestCard = (solicitud, materiales, usuario) => {
            // USANDO LOS ESTADOS CORRECTOS: 'Entregado' Y 'Pendiente'
            const isDelivered = solicitud.estado === 'Entregado';
            const statusClass = isDelivered ? 'card-status-delivered' : 'card-status-pending';
            
            // Renderizar Materiales
            const materialListItems = materiales.map(m => `
                <li>${m.material} (Cantidad: ${m.cantidad})</li>
            `).join('');

            // HTML de la Tarjeta
            let html = `
                <div class="request-card">
                    <div class="card-header">
                        <strong>ID: S-${solicitud.id}</strong>
                        <span>Fecha Solicitud: ${formatDate(solicitud.fecha_solicitud)}</span>
                    </div>
                    <div class="card-detail"><label>Usuario:</label> ${usuario ? usuario.nombre : 'Desconocido'}</div>
                    <div class="card-detail"><label>Docente:</label> ${solicitud.docente}</div>
                    <div class="card-detail"><label>Asignatura:</label> ${solicitud.asignatura}</div>
                    
                    <div class="card-detail material-block">
                        <label>Materiales:</label>
                        <ul class="material-list">
                            ${materialListItems.length > 0 ? materialListItems : '<li>Sin materiales registrados.</li>'}
                        </ul>
                    </div>
                    
                    <div class="card-detail"><label>Estado:</label> <span class="${statusClass}">${solicitud.estado.toUpperCase()}</span></div>
            `;

            // Añadir detalles y botones solo si está Entregado
            if (isDelivered) {
                html += `
                    <div class="card-detail"><label>Entrega:</label> **${formatDate(solicitud.fecha_entrega)}**</div>
                    <div class="actions">
                        <button class="btn-comment" onclick="abrirFormulario('${solicitud.id}')">Agregar Comentario</button>
                        <button class="btn-no-comment" onclick="markAsReviewed('${solicitud.id}')">Sin Comentario</button>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        };

        // Función principal para cargar los datos
        async function loadDashboardData() {
            // Consulta a Supabase con JOINs
            const { data: solicitudesData, error } = await supabase
                .from('solicitudes')
                .select(`
                    *,
                    usuario:usuarios!solicitudes_email_fkey (nombre, email),
                    materiales_solicitados (material, cantidad)
                `)
                .order('fecha_solicitud', { ascending: false })
                .limit(20);

            if (error) {
                console.error('Error al cargar solicitudes:', error);
                pendingContainer.innerHTML = '<p>Error al cargar datos. Verifique la conexión y las RLS de Supabase.</p>';
                deliveredContainer.innerHTML = '<p>Error al cargar datos. Verifique la conexión y las RLS de Supabase.</p>';
                return;
            }

            // Filtrar y limitar las listas a 10 elementos cada una usando los estados correctos: 'Pendiente' y 'Entregado'
            const pendingRequests = solicitudesData
                .filter(s => s.estado === 'Pendiente')
                .slice(0, 10);
                
            const deliveredRequests = solicitudesData
                .filter(s => s.estado === 'Entregado')
                .slice(0, 10);

            // Renderizar Tarjetas Pendientes
            if (pendingRequests.length === 0) {
                 pendingContainer.innerHTML = '<p>No hay solicitudes pendientes.</p>';
            } else {
                pendingContainer.innerHTML = pendingRequests.map(s => 
                    createRequestCard(s, s.materiales_solicitados, s.usuario)
                ).join('');
            }

            // Renderizar Tarjetas Entregadas
            if (deliveredRequests.length === 0) {
                 deliveredContainer.innerHTML = '<p>No hay solicitudes entregadas.</p>';
            } else {
                deliveredContainer.innerHTML = deliveredRequests.map(s => 
                    createRequestCard(s, s.materiales_solicitados, s.usuario)
                ).join('');
            }
        }

        // Funciones de acción de botones (solo alertas como placeholder)
        window.abrirFormulario = (solicitudId) => {
            alert(`Acción: Implementar formulario para agregar comentario a S-${solicitudId}`);
        };

        window.markAsReviewed = (solicitudId) => {
            if(confirm(`¿Confirmar revisión de la Solicitud S-${solicitudId} sin comentarios?`)) {
                // Lógica de UPDATE en Supabase iría aquí
                alert(`S-${solicitudId} marcada como revisada. (Se necesita implementar UPDATE en BD)`);
            }
        };


        // Cargar los datos al iniciar la página
        loadDashboardData();
    </script>

</body>
</html>
